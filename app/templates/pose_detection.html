<!DOCTYPE html>
<html lang="zh-tw" data-i18n-pending="true">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="poseDetection.pageTitle">å§¿æ…‹åˆ†æ - Pose Detection</title>
    <!-- Anti-FOUC: inline critical background -->
    <style>
        html, body { margin: 0; padding: 0; }
        body { background: linear-gradient(135deg, #D4C5E8 0%, #C8B8DB 50%, #B8A8D8 100%); min-height: 100vh; }
        body.dark-theme, html.dark-theme-early body { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); }
    </style>
    <script>
        try {
            const preferredLang = localStorage.getItem('preferredLanguage') || 'zh-TW';
            document.documentElement.setAttribute('lang', preferredLang.toLowerCase());
            // Early dark-theme detection to prevent background flash
            var _t = localStorage.getItem('themeMode');
            if (_t === 'dark' || (_t === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark-theme-early');
            }
        } catch (e) {
            // no-op
        }
    </script>
    <!-- Pose detection styles -->
    <!-- Pose detection page styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pose_detection.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/sidebar.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/settings.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="vm-video-page">
    <!-- Decorative animations -->
    <div class="decorative-stars">
        <div class="star" style="top: 10%; left: 5%;">â­</div>
        <div class="star" style="top: 25%; left: 85%;">âœ¨</div>
        <div class="star" style="top: 70%; left: 15%;">ğŸŒŸ</div>
        <div class="star" style="top: 85%; left: 80%;">â­</div>
        <div class="cloud" style="top: 15%; left: 10%;">â˜ï¸</div>
        <div class="cloud" style="top: 60%; left: 75%;">â˜ï¸</div>
    </div>

    <!-- Owl Decoration -->
    <div class="owl-decoration">ğŸ¦‰</div>

    <header class="vm-topbar">
        <div class="vm-topbar__inner">
            <button class="btn btn-secondary vm-topbar__back" onclick="window.location.href='/'">
                <i class="fas fa-arrow-left"></i>
                <span data-i18n="poseDetection.back">è¿”å›</span>
            </button>
            <div class="vm-topbar__title">
                <span class="vm-topbar__titleText" data-i18n="poseDetection.title">å§¿æ…‹åˆ†æ Pose Detection</span>
            </div>
            <div class="vm-topbar__right">
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="pose-page-content">
        <!-- Video Section -->
        <section class="video-section">
            <div class="video-wrapper" id="videoWrapper">
                <video id="poseVideo" autoplay playsinline></video>
                <canvas id="poseCanvas"></canvas>
                <div class="video-placeholder">
                    <i class="fas fa-video"></i>
                    <p data-i18n="poseDetection.videoPlaceholder">é»æ“Šã€Œé–‹å§‹æª¢æ¸¬ã€å•Ÿå‹•æ”å½±æ©Ÿ</p>
                </div>
            </div>
            
            <div class="controls-section">
                <button class="control-btn" id="startBtn">
                    <i class="fas fa-play"></i>
                    <span data-i18n="poseDetection.startDetection">é–‹å§‹æª¢æ¸¬</span>
                </button>
                <button class="control-btn stop" id="stopBtn" style="display: none;">
                    <i class="fas fa-stop"></i>
                    <span data-i18n="poseDetection.stopDetection">åœæ­¢æª¢æ¸¬</span>
                </button>
                <button class="control-btn reset" id="resetBtn" style="display: none;">
                    <i class="fas fa-undo"></i>
                    <span data-i18n="poseDetection.resetSelection">é‡æ–°é¸æ“‡</span>
                </button>
            </div>
            
            <!-- Selection Status Indicator -->
            <div class="selection-status" id="selectionStatus" style="display: none;">
                <span class="status-icon"><i class="fas fa-crosshairs"></i></span>
                <span class="status-text" id="selectionStatusText" data-i18n="poseDetection.selectionHint">é»æ“Šç•«é¢é¸æ“‡è¦è¿½è¹¤çš„äºº</span>
            </div>
        </section>

        <!-- Info Panel -->
        <aside class="info-panel">
            <!-- Current Action Card -->
            <div class="info-card current-action-card">
                <div class="card-label" data-i18n="poseDetection.currentAction">ç›®å‰å‹•ä½œ</div>
                <span class="status-value inactive" id="currentActionValue">â€”</span>
            </div>

            <!-- Current Test Action Card -->
            <div class="info-card current-test-action-card">
                <div class="card-label" data-i18n="poseDetection.currentTestAction">ç•¶å‰æ¸¬é©—å‹•ä½œ</div>
                <div class="current-test-action-content" id="currentTestActionContent">
                    <div class="test-action-icon" id="testActionIcon">ğŸ¯</div>
                    <div class="test-action-name" id="testActionName">â€”</div>
                    <div class="test-action-instruction" id="testActionInstruction" data-i18n="poseDetection.testActionInstruction">è«‹å…ˆé–‹å§‹æ¸¬é©—</div>
                </div>
            </div>

            <!-- Assessment Card (5-action test) -->
            <div class="info-card assessment-card">
                <div class="card-label" data-i18n="poseDetection.testTitle">å‹•ä½œæ¸¬é©—</div>

                <div class="test-row">
                    <span class="test-label" data-i18n="poseDetection.testProgress">é€²åº¦</span>
                    <span class="test-value" id="testProgressValue">â€”</span>
                </div>
                <div class="test-row">
                    <span class="test-label" data-i18n="poseDetection.testScore">åˆ†æ•¸</span>
                    <span class="test-value" id="testScoreValue">0 / 5</span>
                </div>

                <div class="test-hint" id="testHint" data-i18n="poseDetection.testHint">
                    å…ˆé»ã€Œé–‹å§‹æª¢æ¸¬ã€ï¼Œå†é»ç•«é¢é¸æ“‡è¦è¿½è¹¤çš„äººï¼Œç„¶å¾Œé–‹å§‹æ¸¬é©—ã€‚
                </div>

                <div class="test-controls">
                    <button class="test-btn" id="startTestBtn" disabled data-i18n="poseDetection.startTest">é–‹å§‹æ¸¬é©—</button>
                    <button class="test-btn secondary" id="skipTestBtn" disabled data-i18n="poseDetection.skipTest">è·³é</button>
                    <button class="test-btn secondary" id="resetTestBtn" disabled data-i18n="poseDetection.resetTest">é‡è¨­</button>
                </div>

                <!-- Detailed evaluation panel (hidden until result available) -->
                <div class="evaluation-panel" id="evaluationPanel" style="display:none; margin-top:20px;">
                    <button class="test-btn" id="showReportBtn" style="width:100%; background: linear-gradient(135deg, #6e8efb, #a777e3); color: white; border: none; font-weight: 700; padding:12px; border-radius:12px; cursor:pointer; box-shadow: 0 4px 15px rgba(110, 142, 251, 0.4);">
                        <i class="fas fa-file-alt"></i> <span data-i18n="poseDetection.viewReport">æŸ¥çœ‹è©³ç´°å ±å‘Š</span>
                    </button>
                    <button class="test-btn secondary" id="clearEvalBtn" style="margin-top:12px; width:100%; color: #f44336;">
                        <i class="fas fa-trash-alt"></i> <span data-i18n="poseDetection.clearRecord">æ¸…é™¤ç´€éŒ„</span>
                    </button>
                    <!-- Hidden summaries used by JS to store data -->
                    <div id="evaluationSummary" style="display:none;"></div>
                    <div id="evaluationDetails" style="display:none;"></div>
                </div>
            </div>

            <!-- Detection Info Card -->
            <div class="info-card">
                <div class="card-label" data-i18n="poseDetection.detectionInfo">åµæ¸¬è³‡è¨Š</div>
                <div class="info-rows">
                    <div class="info-row">
                        <span class="info-key" data-i18n="poseDetection.mode">æ¨¡å¼</span>
                        <span class="info-val" id="detectionModeValue">â€”</span>
                    </div>
                    <div class="info-row">
                        <span class="info-key" data-i18n="poseDetection.detectedCount">åµæ¸¬äººæ•¸</span>
                        <span class="info-val" id="detectedPersonCountValue">â€”</span>
                    </div>
                    <div class="info-row">
                        <span class="info-key" data-i18n="poseDetection.trackedTarget">è¿½è¹¤å°è±¡</span>
                        <span class="info-val" id="trackedPersonValue">â€”</span>
                    </div>
                    <div class="info-row">
                        <span class="info-key" data-i18n="poseDetection.trackingDistance">è¿½è¹¤è·é›¢</span>
                        <span class="info-val" id="trackingDistanceValue">â€”</span>
                    </div>
                    <div class="info-row">
                        <span class="info-key">FPS</span>
                        <span class="info-val" id="fpsValue">â€”</span>
                    </div>
                    <div class="info-row">
                        <span class="info-key" data-i18n="poseDetection.frameTime">è™•ç†æ™‚é–“</span>
                        <span class="info-val" id="frameTimeValue">â€”</span>
                    </div>
                </div>
            </div>

            <!-- Error Container -->
            <div class="error-container" id="errorContainer">
                <div class="error-title" id="errorTitle" data-i18n="poseDetection.errorTitle">éŒ¯èª¤</div>
                <div class="error-message" id="errorMessage"></div>
            </div>
        </aside>
    </main>

    <!-- Floating Actions: Settings & Logout -->
    <div class="floating-actions" aria-label="å¿«é€Ÿæ“ä½œ">
        <button id="settings" class="floating-btn" type="button" title="è¨­å®š">
            <i class="fas fa-gear"></i>
            <span data-i18n="settings">è¨­å®š</span>
        </button>
        <button id="logout" class="floating-btn danger" type="button" title="ç™»å‡º">
            <i class="fas fa-right-from-bracket"></i>
            <span data-i18n="logout">ç™»å‡º</span>
        </button>
    </div>

    <!-- Socket.IO Client Library -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <!-- MediaPipe Holistic Library (543 landmarks: 33 pose + 468 face + 21*2 hands) -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic/holistic.js" crossorigin="anonymous"></script>

    
    <!-- 3D Pose detection modules -->
    <script src="{{ url_for('main.serve_pose_detection_js', filename='pose_error_handler.js') }}"></script>
    <script src="{{ url_for('main.serve_pose_detection_js', filename='pose_detector_3d.js') }}"></script>
    <script src="{{ url_for('main.serve_pose_detection_js', filename='multi_person_detector.js') }}"></script>
    <script src="{{ url_for('main.serve_pose_detection_js', filename='multi_person_selector.js') }}"></script>
    <script src="{{ url_for('main.serve_pose_detection_js', filename='action_detector.js') }}"></script>
    <script src="{{ url_for('main.serve_pose_detection_js', filename='movement_analyzers.js') }}"></script>
    <script src="{{ url_for('main.serve_pose_detection_js', filename='movement_detector.js') }}"></script>
    <script src="{{ url_for('main.serve_pose_detection_js', filename='movement_descriptor.js') }}"></script>
    <script src="{{ url_for('main.serve_pose_detection_js', filename='pose_renderer.js') }}"></script>

    <!-- Detailed Report Modal Overlay -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-content" id="modalContent">
            <div class="modal-header">
                <span class="modal-title" data-i18n="poseDetection.modalTitle">ğŸ“Š è©•ä¼°è¨ºæ–·å ±å‘Š</span>
                <button class="close-modal" id="closeModalBtn">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content will be injected by JS -->
            </div>
        </div>
    </div>

    <!-- Page-specific script (extracted) -->
    <script src="{{ url_for('static', filename='js/pose_detection.js') }}"></script>

    <!-- Settings Modal -->
    {% include 'setting.html' %}
    <script src="../static/js/settings.js"></script>

    <!-- Auth and settings handlers -->
    <script>
        // Settings button handler
        const settingsBtn = document.getElementById('settings');
        if (settingsBtn) {
            settingsBtn.addEventListener('click', () => {
                const settingsModal = document.getElementById('settingsModal');
                if (settingsModal) {
                    settingsModal.style.display = 'flex';
                }
            });
        }

        // Logout button handler
        const logoutBtn = document.getElementById('logout');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', async () => {
                localStorage.removeItem('access_token');
                window.location.href = '/login';
            });
        }
    </script>
</body>
</html>
