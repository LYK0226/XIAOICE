<!DOCTYPE html>
<html lang="zh-tw" data-i18n-pending="true">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠå¤©ç›’å­ - Chatbox</title>
    <!-- Anti-FOUC: inline critical background -->
    <style>
        html, body { margin: 0; padding: 0; }
        body { background: linear-gradient(135deg, #D4C5E8 0%, #C8B8DB 100%); min-height: 100vh; }
        body.dark-theme, html.dark-theme-early body { background: linear-gradient(135deg, #2D2736 0%, #1F1B24 100%); }
    </style>
    <script>
        try {
            const preferredLang = localStorage.getItem('preferredLanguage') || 'zh-TW';
            document.documentElement.setAttribute('lang', preferredLang.toLowerCase());
            // Early dark-theme detection to prevent background flash
            var _t = localStorage.getItem('themeMode');
            if (_t === 'dark' || (_t === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark-theme-early');
            }
        } catch (e) {
            // no-op
        }
    </script>
    <!-- Main chat interface styles -->
    <link rel="stylesheet" href="../static/css/chatbox.css">
    <!-- Sidebar styles -->
    <link rel="stylesheet" href="../static/css/sidebar.css">
    <!-- Settings modal styles -->
    <link rel="stylesheet" href="../static/css/settings.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div id="sidebar">
        <div class="sidebar-header">
            <button type="button" class="sidebar-toggle" id="sidebarToggle" title="Toggle sidebar"><i class="fas fa-bars"></i></button>
            <i class="fas fa-comment"></i>
            <h2>èŠå¤©ç›’å­</h2>
        </div>
        
        <div class="sidebar-section">
            <h3>èŠå¤©</h3>
            <ul class="chat-list">
                <li class="empty-state">è¼‰å…¥ä¸­...</li>
            </ul>
        </div>
        
        <div class="sidebar-footer">
            <button type="button" class="sidebar-btn" id="newChat"><i class="fas fa-plus"></i> <span data-i18n="newChat">æ–°å°è©±</span></button>
            <button type="button" class="sidebar-btn" id="exitChatroom" onclick="window.location.href='/index'"><i class="fas fa-arrow-left"></i> <span data-i18n="exitChatroom">é€€å‡ºèŠå¤©å®¤</span></button>
            <button type="button" class="sidebar-btn" id="settings"><i class="fas fa-cog"></i> <span data-i18n="settings">è¨­å®š</span></button>
            <button type="button" class="sidebar-btn" id="logout"><i class="fas fa-sign-out-alt"></i> <span data-i18n="logout">ç™»å‡º</span></button>
        </div>
    </div>
    
    <div id="main-content">
        <div id="chat-container">
            <div id="chat-header">
                <div class="chat-title">
                    <button type="button" class="sidebar-show-btn" id="sidebarShowBtn" style="display: none;" title="Show sidebar"><i class="fas fa-bars"></i></button>
                    <i class="fas fa-comment"></i>
                    <span>èŠå¤©ç›’å­</span>
                </div>
                <div class="chat-actions">
                    <button type="button" class="icon-btn" title="Search"><i class="fas fa-search"></i></button>
                    <button type="button" class="icon-btn" title="User profile"><i class="fas fa-user-circle"></i></button>
                    <button type="button" class="icon-btn" title="More options"><i class="fas fa-ellipsis-h"></i></button>
                </div>
            </div>
            
            <div id="messages">
            </div>
            
            <!-- Gemini-style welcome screen (shown when no conversation is active) -->
            <div id="welcome-screen">
                <div class="welcome-content">
                    <div class="welcome-avatar-circle">
                        <i class="fas fa-robot"></i>
                    </div>
                    <h2 class="welcome-title">XIAOICE</h2>
                    <p class="welcome-subtitle" id="welcomeSubtitleText">æ‚¨å¥½ï¼æˆ‘æ˜¯ XIAOICEï¼Œå°ˆæ³¨æ–¼å¹¼å…’æˆé•·åˆ†æçš„å…’ç«¥ç™¼è‚²é™ªä¼´è€…ã€‚</p>
                </div>
            </div>
            
            <div id="input-container">
                <div class="input-wrapper">
                    <!-- Plus button + its popup (wrapped so popup is always above button) -->
                    <div class="btn-popup-wrapper">
                        <div id="plusMenu" class="plus-menu" style="display:none;">
                            <button type="button" class="plus-menu-item" id="fileUploadBtn">
                                <span class="pmi-icon"><i class="fas fa-paperclip"></i></span>
                                <span class="pmi-label">ä¸Šè¼‰æ–‡ä»¶</span>
                            </button>
                            <button type="button" class="plus-menu-item" id="voiceInputBtn">
                                <span class="pmi-icon"><i class="fas fa-microphone"></i></span>
                                <span class="pmi-label">èªéŸ³è¼¸å…¥</span>
                            </button>
                            <button type="button" class="plus-menu-item" id="webcamBtn">
                                <span class="pmi-icon"><i class="fas fa-camera"></i></span>
                                <span class="pmi-label">æ”å½±æ©Ÿ</span>
                            </button>
                        </div>
                        <button type="button" id="plusMenuBtn" class="input-action-btn plus-btn" title="æ›´å¤šé¸é …">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>

                    <textarea id="messageInput" rows="1" placeholder="åœ¨é€™è£¡è¼¸å…¥æ‚¨çš„å•é¡Œ..."></textarea>
                    <input type="file" id="fileInput" accept="image/*,video/*,application/pdf" multiple style="display: none;">

                    <!-- Model selector + its popup (wrapped so popup is always above button) -->
                    <div class="btn-popup-wrapper">
                        <div id="modelDropdown" class="model-dropdown" style="display:none;">
                            <button type="button" class="model-dropdown-item" data-model="gemini-3-flash-preview">
                                <span class="mdi-icon">âš¡</span>
                                <div class="mdi-info">
                                    <span class="mdi-name">Flash</span>
                                    <span class="mdi-desc">å¿«é€Ÿå›æ‡‰ãƒ»æ—¥å¸¸å°è©±</span>
                                </div>
                            </button>
                            <button type="button" class="model-dropdown-item" data-model="gemini-3.1-pro-preview">
                                <span class="mdi-icon">ğŸ’</span>
                                <div class="mdi-info">
                                    <span class="mdi-name">Pro</span>
                                    <span class="mdi-desc">å¼·å¤§ç²¾æº–ãƒ»æ·±åº¦åˆ†æ</span>
                                </div>
                            </button>
                        </div>
                        <button type="button" id="inputModelBtn" class="input-model-btn" title="åˆ‡æ› AI æ¨¡å‹">
                            <span id="inputModelLabel">Flash</span>
                            <i class="fas fa-chevron-up" id="inputModelChevron"></i>
                        </button>
                    </div>

                    <button type="button" id="sendButton" title="Send message"><i class="fas fa-paper-plane"></i></button>
                    <button type="button" id="poseDetectionPageBtn" class="pose-page-btn" title="å§¿æ…‹åˆ†æ" onclick="window.location.href='/pose_detection'"><i class="fas fa-running"></i></button>
                </div>
                
                <!-- File Preview Container -->
                <div id="filePreviewContainer" class="file-preview-container" style="display: none;"></div>
                
                <!-- Emoji Picker (kept for potential use) -->
                <div id="emojiPicker" class="emoji-picker" style="display: none;">
                    <div class="emoji-header">
                        <span class="emoji-tab active" data-category="smileys">ğŸ˜Š</span>
                        <span class="emoji-tab" data-category="gestures">ğŸ‘‹</span>
                        <span class="emoji-tab" data-category="animals">ğŸ±</span>
                        <span class="emoji-tab" data-category="food">ğŸ•</span>
                        <span class="emoji-tab" data-category="activities">âš½</span>
                        <span class="emoji-tab" data-category="travel">âœˆï¸</span>
                        <span class="emoji-tab" data-category="objects">ğŸ’¡</span>
                        <span class="emoji-tab" data-category="symbols">â¤ï¸</span>
                    </div>
                    <div class="emoji-content" id="emojiContent"></div>
                </div>
                
                <!-- Webcam Modal -->
                <div id="webcamModal" class="webcam-modal" style="display: none;">
                    <div class="webcam-content">
                        <div class="webcam-header">
                            <h3>æ‹ç…§</h3>
                            <button type="button" class="close-webcam" id="closeWebcam" title="Close webcam">&times;</button>
                        </div>
                        <div class="webcam-body">
                            <video id="webcamVideo" autoplay playsinline></video>
                            <canvas id="webcamCanvas" style="display: none;"></canvas>
                        </div>
                        <div class="webcam-footer">
                            <button type="button" class="webcam-action-btn" id="captureBtn"><i class="fas fa-camera"></i> æ‹ç…§</button>
                            <button type="button" class="webcam-action-btn" id="retakeBtn" style="display: none;"><i class="fas fa-redo"></i> é‡æ‹</button>
                            <button type="button" class="webcam-action-btn primary" id="usePhotoBtn" style="display: none;"><i class="fas fa-check"></i> ä½¿ç”¨ç…§ç‰‡</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Document Preview Panel -->
        <div id="preview-panel" class="preview-panel" style="display: none;">
            <div class="preview-header">
                <h3 id="preview-title">Document Preview</h3>
                <button type="button" class="close-preview" id="closePreview" title="Close preview">&times;</button>
            </div>
            <div class="preview-content" id="preview-content">
                <!-- Preview content will be inserted here -->
            </div>
        </div>
    </div>
    

    <!-- Settings Modal (included from separate file) -->
    {% include 'setting.html' %}
    
    <!-- Auth check script -->
    <script>
        if (!localStorage.getItem('access_token')) {
            window.location.href = '/login';
        }

        // Handle logout
        document.getElementById('logout').addEventListener('click', async () => {
            localStorage.removeItem('access_token');
            window.location.href = '/login';
        });
    </script>
    
    <!-- Socket.IO Client Library -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <!-- WebSocket Manager Module -->
    <script src="../static/js/socket_module.js"></script>
    <!-- å…ˆè¼‰å…¥ API æ¨¡å¡Š -->
    <script src="../static/js/api_module.js"></script>
    <script src="../static/js/sidebar.js"></script>
    <script src="../static/js/chatbox.js"></script>
    <script src="../static/js/settings.js"></script>
    <script src="../static/js/uploads.js"></script>

</body>
</html>