<!DOCTYPE html>
<html lang="zh-tw" data-i18n-pending="true">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="videoAccess.pageTitle">å½±ç‰‡ä¸Šè¼‰èˆ‡åˆ†æ</title>
    <!-- Anti-FOUC: inline critical background -->
    <style>
        html, body { margin: 0; padding: 0; }
        body { background: linear-gradient(135deg, #D4C5E8 0%, #C8B8DB 50%, #B8A8D8 100%); min-height: 100vh; }
        body.dark-theme, html.dark-theme-early body { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #1a1a2e 100%); color: #E2D7F5; }
    </style>
    <script>
        try {
            const preferredLang = localStorage.getItem('preferredLanguage') || 'zh-TW';
            document.documentElement.setAttribute('lang', preferredLang.toLowerCase());
            // Early dark-theme detection to prevent background flash
            var _t = localStorage.getItem('themeMode');
            if (_t === 'dark' || (_t === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark-theme-early');
            }
        } catch (e) {
            // no-op
        }
    </script>

    <!-- Reuse existing styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/chatbox.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/video_access.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/settings.css') }}">
    <!-- Index styles for floating actions (settings & logout) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="vm-video-page">
    <!-- Decorative animations -->
    <div class="decorative-stars">
        <div class="star" style="top: 10%; left: 5%;">â­</div>
        <div class="star" style="top: 25%; left: 85%;">âœ¨</div>
        <div class="star" style="top: 70%; left: 15%;">ğŸŒŸ</div>
        <div class="star" style="top: 85%; left: 80%;">â­</div>
        <div class="cloud" style="top: 15%; left: 10%;">â˜ï¸</div>
        <div class="cloud" style="top: 60%; left: 75%;">â˜ï¸</div>
    </div>

    <!-- Owl Decoration -->
    <div class="owl-decoration">ğŸ¦‰</div>

    <header class="vm-topbar">
        <div class="vm-topbar__inner">
            <button class="btn btn-secondary vm-topbar__back" onclick="window.location.href='/'">
                <i class="fas fa-arrow-left"></i>
                <span data-i18n="videoAccess.back">è¿”å›</span>
            </button>
        </div>
    </header>

    <!-- Minimal stub button required by video_access.js -->
    <button id="videoUploadBtn" style="display:none;"></button>

    <main class="vm-shell">
        <div class="vm-container">
            <section class="vm-hero" aria-label="Video upload intro">
                <div class="vm-hero__content">
                    <div class="vm-hero__badge">
                        <span class="vm-hero__dot" aria-hidden="true"></span>
                        <span data-i18n="videoAccess.hero.badge">è¦ªå­å°å¹«æ‰‹</span>
                    </div>
                    <h1 class="vm-hero__title" data-i18n="videoAccess.hero.title">ä¸€èµ·ä¸Šè¼‰å½±ç‰‡ï¼Œè®“ AI å¹«ä½ æ•´ç†é‡é»</h1>
                    <p class="vm-hero__desc">
                        <span data-i18n="videoAccess.hero.descLine1">çµ¦å®¶é•·ï¼šå¿«é€ŸæŸ¥çœ‹è½‰éŒ„ã€æ™‚é–“æˆ³è¨˜èˆ‡åˆ†æå ±å‘Šã€‚</span><br>
                        <span data-i18n="videoAccess.hero.descLine2">çµ¦å°æœ‹å‹ï¼šåªè¦é¸å½±ç‰‡ä¸¦æŒ‰ã€Œæäº¤ã€ï¼Œå…¶é¤˜äº¤çµ¦æˆ‘å€‘ã€‚</span>
                    </p>
                    <div class="vm-hero__tips" role="note">
                        <div class="vm-tip"><span class="vm-tip__icon">âœ…</span> <span data-i18n="videoAccess.hero.tip1">é¿å…èƒŒæ™¯é›œäº‚ã€é¡é ­æ™ƒå‹•ã€ä¿æŒå…‰ç·šå……è¶³</span></div>
                        <div class="vm-tip"><span class="vm-tip__icon">ğŸ›¡ï¸</span> <span data-i18n="videoAccess.hero.tip2">é¿å…å¤šäººåŒæ™‚å…¥é¡ä¸¦ç¢ºä¿å°æœ‹å‹å…¨èº«éƒ½åœ¨ç•«é¢å…§</span></div>
                        <div class="vm-tip"><span class="vm-tip__icon">ğŸ”Š</span> <span data-i18n="videoAccess.hero.tip3">è²éŸ³æ¸…æ¥šæœƒè®“è½‰éŒ„æ›´æº–</span></div>
                    </div>
                </div>
                <div class="vm-hero__art" aria-hidden="true">
                    <div class="vm-hero__blob vm-hero__blob--a"></div>
                    <div class="vm-hero__blob vm-hero__blob--b"></div>
                    <div class="vm-hero__card">
                        <div class="vm-hero__cardTitle" data-i18n="videoAccess.hero.cardTitle">å°æé†’</div>
                        <div class="vm-hero__cardRow"><span>ğŸ¬</span><span data-i18n="videoAccess.hero.cardRow1">ä¸Šè¼‰å¾Œå¯ç«‹å³é è¦½</span></div>
                        <div class="vm-hero__cardRow"><span>ğŸ§ </span><span data-i18n="videoAccess.hero.cardRow2">åˆ†æå®Œæˆå¯ä¸‹è¼‰å ±å‘Š</span></div>
                    </div>
                </div>
            </section>

            <!-- Video Management Modal (reused and shown as full-page) -->
            <div id="videoModal" class="video-modal vm-modal--page" style="display: flex; position: static;">
                <div class="video-modal-content vm-modal__content">
                    <div class="video-modal-header">
                        <div class="vm-headerTitle">
                            <div class="vm-headerTitle__kicker" data-i18n="videoAccess.modal.kicker">Video Studio</div>
                            <h2 data-i18n="videoAccess.modal.title">å½±ç‰‡ä¸Šè¼‰èˆ‡åˆ†æ</h2>
                        </div>
                        <!-- Keep element for JS binding; hide because this page is dedicated -->
                        <button class="close-video-modal" id="closeVideoModal" style="display:none;">&times;</button>
                    </div>

                    <div class="video-modal-body">
                         <div class="vm-layout-grid">
                            <!-- Sidebar: Upload -->
                            <aside class="vm-layout-sidebar">
                                <section class="vm-card video-upload-section">
                                    <div class="vm-card__header">
                                        <h3 data-i18n="videoAccess.upload.sectionTitle">ä¸Šè¼‰å½±ç‰‡</h3>
                                    </div>
                                    <div class="vm-hint" id="uploadHint" style="margin-bottom:12px;" data-i18n="videoAccess.upload.hint">
                                        æ”¯æ´ MP4 / MOV / AVI ç­‰ï¼ˆæœ€å¤§ 500MBï¼‰
                                    </div>

                                    <div class="video-upload-zone" id="videoUploadZone" style="cursor: pointer;">
                                        <div class="vm-uploadZone__icon">
                                            <i class="fas fa-video"></i>
                                        </div>
                                        <div class="vm-uploadZone__text">
                                            <p data-i18n="videoAccess.upload.dropText">æ‹–æ”¾æˆ–é»æ“Šä¸Šè¼‰</p>
                                            <small data-i18n="videoAccess.upload.dropHint">æç¤ºï¼šé¡é ­ç©©ã€å…‰ç·šäº®</small>
                                        </div>
                                    </div>
                                    <input type="file" id="videoModalInput" accept="video/*,audio/*" style="display: none;">

                                    <!-- Child Selection -->
                                    <div id="childSelectionArea" class="vm-child-select" style="margin-top: 16px;">
                                        <h4 class="vm-sectionTitle" data-i18n="videoAccess.child.sectionTitle">é¸æ“‡åˆ†æå°è±¡</h4>
                                        <div id="childSelectWrapper" style="display:flex;flex-direction:column;gap:8px;">
                                            <select id="childSelect" class="vm-select" style="width:100%;">
                                                <option value="" data-i18n="videoAccess.child.placeholder">â€” è«‹é¸æ“‡å…’ç«¥ â€”</option>
                                            </select>
                                            <div style="display:flex;justify-content:space-between;align-items:center;">
                                                <span id="childAgeDisplay" class="vm-muted" style="font-size:0.85em;"></span>
                                                <button type="button" id="addChildHintBtn" class="btn btn-secondary btn-sm" style="display:none;padding:4px 8px;font-size:12px;"
                                                        onclick="window.location.href='/settings#children'">
                                                    <i class="fas fa-plus"></i> <span data-i18n="videoAccess.child.add">æ–°å¢</span>
                                                </button>
                                            </div>
                                        </div>
                                        <p id="noChildWarning" class="vm-warning" style="display:none;margin-top:8px;color:#b00020;font-size:12px;">
                                            <span data-i18n="videoAccess.child.noChildWarningPrefix">âš ï¸ è«‹å…ˆè‡³</span><a href="/settings#children" data-i18n="videoAccess.child.noChildWarningLink">è¨­å®š</a><span data-i18n="videoAccess.child.noChildWarningSuffix">æ·»åŠ å…’ç«¥è³‡æ–™</span>
                                        </p>
                                    </div>

                                    <!-- Preview area -->
                                    <div id="previewArea" class="vm-preview" style="display: none; margin-top: 16px;">
                                        <h4 class="vm-sectionTitle" data-i18n="videoAccess.preview.sectionTitle">é è¦½èˆ‡ç¢ºèª</h4>
                                        <!-- Simplified Preview Layout for Sidebar -->
                                        <div class="vm-preview__mini">
                                            <video id="previewPlayer" controls class="vm-preview__player" style="width:100%;border-radius:8px;margin-bottom:8px;"></video>
                                            <div id="previewMeta" class="vm-muted" style="font-size:12px;margin-bottom:12px;"></div>
                                            <div style="display:grid;gap:8px;">
                                                <button id="submitUploadBtn" class="btn btn-primary" style="width:100%" disabled data-i18n="videoAccess.preview.submit">æäº¤å½±ç‰‡</button>
                                                <button id="cancelPreviewBtn" class="btn btn-secondary" style="width:100%" data-i18n="videoAccess.preview.cancel">å–æ¶ˆ</button>
                                            </div>
                                        </div>
                                    </div>

                                    <div id="uploadProgress" style="display: none; margin-top: 15px;">
                                        <div class="progress-bar">
                                            <div class="progress-fill"></div>
                                        </div>
                                        <p id="uploadStatus" style="text-align:center;font-size:12px;" data-i18n="videoAccess.upload.statusUploading">ä¸Šè¼‰ä¸­...</p>
                                    </div>
                                </section>
                            </aside>

                            <!-- Main Content -->
                            <main class="vm-layout-main">
                                <!-- Video Details Section -->
                                <section id="videoDetails" class="vm-card video-details-section" style="display: none;">
                                    <div class="vm-card__header">
                                        <h3 data-i18n="videoAccess.details.title">å½±ç‰‡è©³æƒ…</h3>
                                        <div class="vm-hint" data-i18n="videoAccess.details.hint">æ’­æ”¾ã€æŸ¥çœ‹è½‰éŒ„é€²åº¦ã€ä¸¦è¼¸å‡ºåˆ†æå ±å‘Š</div>
                                    </div>

                                    <!-- Video Player -->
                                    <div class="video-player-section" style="margin-bottom: 18px;">
                                        <video id="videoPlayer" class="video-player" controls style="width: 100%; max-height: 520px; border-radius: 12px; background: #000;">
                                            <source id="videoSource" type="video/mp4">
                                            <span data-i18n="videoAccess.details.videoNotSupported">æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´è¦–é »æ’­æ”¾</span>
                                        </video>
                                    </div>

                                    <div class="video-detail-container">
                                        <div class="detail-row">
                                            <span class="detail-label" data-i18n="videoAccess.details.filename">æª”å</span>
                                            <span class="detail-value" id="detailFileName"></span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="detail-label" data-i18n="videoAccess.details.filesize">æª”æ¡ˆå¤§å°</span>
                                            <span class="detail-value" id="detailFileSize"></span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="detail-label" data-i18n="videoAccess.details.duration">æ™‚é•·</span>
                                            <span class="detail-value" id="detailDuration"></span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="detail-label" data-i18n="videoAccess.details.transcriptionStatus">è½‰éŒ„ç‹€æ…‹</span>
                                            <span class="detail-value" id="detailTranscriptionStatus">
                                                <span id="transcriptionStatusBadge" class="status-badge" data-i18n="videoAccess.details.transcriptionWaiting">ç­‰å¾…ä¸­</span>
                                            </span>
                                        </div>
                                    </div>

                                    <div class="vm-grid2">
                                        <!-- Real-time Transcription Progress -->
                                        <div class="vm-panel vm-panel--accent">
                                            <div class="vm-panel__header">
                                                <div class="vm-panel__title">
                                                    <i class="fas fa-microphone"></i>
                                                    <span data-i18n="videoAccess.transcription.progressTitle">è½‰éŒ„é€²åº¦</span>
                                                </div>
                                                <span id="transcriptionPercentage" class="vm-panel__stat">0%</span>
                                            </div>
                                            <div class="transcription-progress-bar">
                                                <div id="transcriptionProgressFill" class="transcription-progress-fill" style="width: 0%;"></div>
                                            </div>
                                            <p id="transcriptionProgressText" class="vm-panel__hint" data-i18n="videoAccess.transcription.waiting">ç­‰å¾…é–‹å§‹è½‰éŒ„...</p>
                                        </div>

                                        <div class="vm-panel">
                                            <div class="vm-panel__header">
                                                <div class="vm-panel__title">
                                                    <i class="fas fa-file-alt"></i>
                                                    <span data-i18n="videoAccess.transcription.textTitle">è½‰éŒ„æ–‡æœ¬</span>
                                                    <span id="wordCount" class="vm-muted" data-i18n="videoAccess.transcription.wordCount">0 å­—</span>
                                                </div>
                                            </div>
                                            <div id="transcriptionContainer" class="transcription-container">
                                                <p id="transcriptionText" class="vm-empty" data-i18n="videoAccess.transcription.empty">å°šæœªè½‰éŒ„</p>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="vm-grid2" style="margin-top: 16px;">
                                        <!-- Timestamps -->
                                        <div class="vm-panel">
                                            <div class="vm-panel__header">
                                                <div class="vm-panel__title">
                                                    <i class="fas fa-list"></i>
                                                    <span data-i18n="videoAccess.timestamps.title">æ™‚é–“æˆ³è¨˜</span>
                                                </div>
                                            </div>
                                            <div id="timestampsContainer" class="timestamps-container">
                                                <p class="vm-empty" data-i18n="videoAccess.timestamps.empty">æœªæœ‰æ™‚é–“æˆ³è¨˜</p>
                                            </div>
                                        </div>

                                        <!-- Analysis Report -->
                                        <div class="vm-panel">
                                            <div class="vm-panel__header">
                                                <div class="vm-panel__title">
                                                    <i class="fas fa-brain"></i>
                                                    <span data-i18n="videoAccess.analysis.title">AI åˆ†æå ±å‘Š</span>
                                                </div>
                                            </div>
                                            <div id="analysisContainer" class="analysis-container">
                                                <p class="vm-empty" data-i18n="videoAccess.analysis.empty">æœªæœ‰åˆ†æ</p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Action Buttons -->
                                    <div class="video-action-buttons vm-actions" style="margin-top: 20px;">
                                        <button id="analyzeVideoBtn" class="btn btn-primary"><i class="fas fa-brain"></i> <span data-i18n="videoAccess.actions.analyze">é–‹å§‹åˆ†æ</span></button>
                                        <button id="pauseAnalysisBtn" class="btn btn-warning" style="display: none;"><i class="fas fa-pause"></i> <span data-i18n="videoAccess.actions.pause">æš«åœåˆ†æ</span></button>
                                        <button id="resumeAnalysisBtn" class="btn btn-info" style="display: none;"><i class="fas fa-play"></i> <span data-i18n="videoAccess.actions.resume">ç¹¼çºŒåˆ†æ</span></button>
                                        <button id="downloadReportBtn" class="btn btn-secondary"><i class="fas fa-download"></i> <span data-i18n="videoAccess.actions.download">ä¸‹è¼‰å ±å‘Š</span></button>
                                        <button id="deleteVideoBtn" class="btn btn-danger"><i class="fas fa-trash"></i> <span data-i18n="videoAccess.actions.delete">åˆªé™¤å½±ç‰‡</span></button>
                                        <button id="backToListBtn" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> <span data-i18n="videoAccess.actions.back">è¿”å›åˆ—è¡¨</span></button>
                                    </div>
                                </section>

                                <!-- Video Upload History Section -->
                                <section class="vm-card video-history-section">
                                    <div class="vm-card__header">
                                        <h3><i class="fas fa-history"></i> <span data-i18n="videoAccess.history.title">å½±ç‰‡ä¸Šå‚³è¨˜éŒ„</span></h3>
                                        <div class="vm-hint" data-i18n="videoAccess.history.hint">æŸ¥çœ‹å’Œç®¡ç†æ‚¨å·²ä¸Šå‚³çš„å½±ç‰‡</div>
                                    </div>

                                    <div id="videoUploadsListContainer" class="uploads-list-container">
                                        <div class="loading-spinner" style="display: none;">
                                            <i class="fas fa-spinner fa-spin"></i> <span data-i18n="videoAccess.history.loading">è¼‰å…¥ä¸­...</span>
                                        </div>
                                        <div id="videoUploadsList" class="uploads-list"></div>
                                        <div id="videoUploadsEmpty" class="uploads-empty" style="display: none;">
                                            <i class="fas fa-video"></i>
                                            <p data-i18n="videoAccess.history.empty">æ²’æœ‰å½±ç‰‡ä¸Šå‚³è¨˜éŒ„</p>
                                        </div>
                                    </div>
                                </section>
                            </main>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Floating Actions: Settings & Logout -->
    <div class="floating-actions" aria-label="å¿«é€Ÿæ“ä½œ">
        <button id="settings" class="floating-btn" type="button" title="è¨­å®š">
            <i class="fas fa-gear"></i>
            <span data-i18n="settings">è¨­å®š</span>
        </button>
        <button id="logout" class="floating-btn danger" type="button" title="ç™»å‡º">
            <i class="fas fa-right-from-bracket"></i>
            <span data-i18n="logout">ç™»å‡º</span>
        </button>
    </div>

    <!-- Analysis Result Modal (shown after submit) -->
    <div id="analysisResultModal" class="analysis-result-modal" style="display:none;">
        <div class="analysis-result-modal__backdrop" id="analysisResultBackdrop"></div>
        <div class="analysis-result-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="analysisResultTitle">
            <div class="analysis-result-modal__header">
                <h3 id="analysisResultTitle" style="margin:0;" data-i18n="videoAccess.modal.titleResult">åˆ†æçµæœ</h3>
                <button type="button" class="analysis-result-modal__close" id="analysisResultClose" aria-label="Close">&times;</button>
            </div>
            <div id="analysisResultBody" class="analysis-result-modal__body">
                <p data-i18n="videoAccess.modal.loading">åˆ†æä¸­...</p>
            </div>
            <div class="analysis-result-modal__footer">
                <button type="button" class="btn btn-primary" id="analysisResultOk" data-i18n="videoAccess.modal.ok">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <script>
        // Auth check (same behavior as index)
        if (!localStorage.getItem('access_token')) {
            window.location.href = '/login';
        }
    </script>

    <script src="{{ url_for('static', filename='js/video_access.js') }}"></script>
    <script src="{{ url_for('static', filename='js/uploads.js') }}"></script>

    <script>
        // Dedicated page behavior:
        // 1) Keep modal visible (it is already shown)
        // 2) Auto-focus upload zone so user can immediately upload
        document.addEventListener('DOMContentLoaded', () => {
            try {
                const zone = document.getElementById('videoUploadZone');
                // if (zone) zone.scrollIntoView({ behavior: 'smooth', block: 'center' }); // No longer needed with sticky sidebar
            } catch (e) {
                // no-op
            }

            // VideoManager binds to close button and click-outside. No extra capture handlers here so
            // the zone's click can bubble to the file input or the module's listeners as expected.
        });

        // Settings Modal Include
    </script>
    {% include 'setting.html' %}
    <script src="../static/js/settings.js"></script>
    <script>
        // Settings button handler
        const settingsBtn = document.getElementById('settings');
        if (settingsBtn) {
            settingsBtn.addEventListener('click', () => {
                const settingsModal = document.getElementById('settingsModal');
                if (settingsModal) {
                    settingsModal.style.display = 'flex';
                }
            });
        }

        // Logout button handler
        const logoutBtn = document.getElementById('logout');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', async () => {
                localStorage.removeItem('access_token');
                window.location.href = '/login';
            });
        }
    </script>
</body>
</html>