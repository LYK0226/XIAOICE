<!-- Profile Settings Modal -->
<div id="avatarModal" class="modal">
    <div class="modal-content settings-modal">
        <div class="settings-layout">
            <!-- Left Sidebar with Groups -->
            <div class="settings-sidebar">
                <span class="close-avatar">&times;</span>
                <div class="settings-group active" data-group="avatar">
                    <i class="fas fa-user-circle"></i>
                    <span data-i18n="settings.profile">個人資料</span>
                </div>
                <div class="settings-group" data-group="children">
                    <i class="fas fa-child"></i>
                    <span data-i18n="settings.children">小朋友</span>
                </div>
                <div class="settings-group" data-group="personalization">
                    <i class="fas fa-palette"></i>
                    <span data-i18n="settings.personalization">個人化</span>
                </div>
                <div class="settings-group" data-group="advanced">
                    <i class="fa-solid fa-key"></i>
                    <span data-i18n="settings.advanced">高級</span>
                </div>
            </div>
            
            <!-- Right Panel with Options -->
            <div class="settings-panel">
                <!-- Profile Settings -->
                <div class="settings-content active" id="avatarTab">
                    <div class="settings-header">
                        <h3><i class="fas fa-user-circle"></i> <span data-i18n="settings.profile.title">個人資料</span></h3>
                        <p class="settings-description" data-i18n="settings.profile.description">管理您的個人資料和帳戶設定</p>
                    </div>
                    <div class="profile-settings">
                        <!-- Avatar Field -->
                        <div class="profile-item">
                            <label class="field-label" data-i18n="settings.profile.avatar">頭像</label>
                            <div class="field-content">
                                <div class="avatar-preview" id="userAvatarPreview">
                                    <i class="fas fa-user"></i>
                                </div>
                                <input type="file" id="userAvatarInput" accept="image/*" style="display: none;">
                            </div>
                            <div class="field-actions">
                                <button class="edit-btn" onclick="document.getElementById('userAvatarInput').click()">
                                    <i class="fas fa-edit"></i> <span data-i18n="settings.profile.edit">編輯</span>
                                </button>
                                <button class="clear-btn" id="clearUserAvatar">
                                    <i class="fas fa-times"></i> <span data-i18n="settings.profile.clear">清除</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Username Field -->
                        <div class="profile-item">
                            <label class="field-label" data-i18n="settings.profile.username">用戶名稱</label>
                            <div class="field-content">
                                <input type="text" id="profileUsername" readonly>
                            </div>
                            <div class="field-actions">
                                <button class="edit-btn" id="editUsernameBtn">
                                    <i class="fas fa-edit"></i> <span data-i18n="settings.profile.edit">編輯</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Email Field -->
                        <div class="profile-item">
                            <label class="field-label" data-i18n="settings.profile.email">電子郵件</label>
                            <div class="field-content">
                                <input type="email" id="profileEmail" readonly>
                            </div>
                            <div class="field-actions">
                                <button class="edit-btn" id="editEmailBtn">
                                    <i class="fas fa-edit"></i> <span data-i18n="settings.profile.edit">編輯</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Password Field -->
                        <div class="profile-item">
                            <label class="field-label" data-i18n="settings.profile.password">密碼</label>
                            <div class="field-content">
                                <input type="password" id="profilePassword" placeholder="********" readonly>
                            </div>
                            <div class="field-actions">
                                <button class="edit-btn" id="editPasswordBtn">
                                    <i class="fas fa-edit"></i> <span data-i18n="settings.profile.edit">編輯</span>
                                </button>
                            </div>
                        </div>

                        <!-- Delete Account -->
                        <div class="profile-item">
                            <label class="field-label" data-i18n="settings.profile.delete_account">刪除帳號</label>
                            <div class="field-content">
                                <p style="color:#b00020; font-size:14px; margin: 0;" data-i18n="settings.profile.delete_account.desc">刪除帳號會永久移除您的所有資料，無法復原。</p>
                            </div>
                            <div class="field-actions">
                                <button id="deleteAccountBtn" class="clear-btn">
                                    <i class="fas fa-trash"></i> <span data-i18n="settings.profile.delete_account">刪除帳號</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Children Settings -->
                <div class="settings-content" id="childrenTab">
                    <div class="settings-header">
                        <h3><i class="fas fa-child"></i> <span data-i18n="settings.children.title">小朋友資料</span></h3>
                        <p class="settings-description" data-i18n="settings.children.description">管理小朋友的基本資料，用於評估和追蹤發展進度</p>
                    </div>
                    
                    <!-- Children List -->
                    <div class="setting-item">
                        <div class="children-list" id="childrenList">
                            <!-- Children will be loaded here dynamically -->
                            <div class="children-empty" id="childrenEmpty" style="display: none;">
                                <i class="fas fa-child" style="font-size: 48px; opacity: 0.3; margin-bottom: 12px;"></i>
                                <p data-i18n="settings.children.empty">尚未添加小朋友資料</p>
                                <p style="font-size: 14px; opacity: 0.7; margin-top: 8px;" data-i18n="settings.children.empty.hint">點擊下方按鈕添加第一筆資料</p>
                            </div>
                        </div>
                        
                        <button class="add-api-key-btn" id="addChildBtn" style="margin-top: 16px;">
                            <i class="fas fa-plus"></i> <span data-i18n="settings.children.add">添加小朋友</span>
                        </button>
                    </div>
                    
                    <!-- Child Form (shown when adding/editing) -->
                    <div class="child-form" id="childForm" style="display: none;">
                        <div class="form-header">
                            <h4 id="childFormTitle" data-i18n="settings.children.form.add">添加小朋友</h4>
                            <button class="form-close" id="closeChildForm">&times;</button>
                        </div>
                        <div class="form-body">
                            <div class="form-field">
                                <label data-i18n="settings.children.form.name">姓名 *</label>
                                <input type="text" id="childProfileName" placeholder="例如：小明" required>
                            </div>
                            <div class="form-field">
                                <label data-i18n="settings.children.form.birthdate">生日 *</label>
                                <input type="date" id="childProfileBirthdate" required>
                            </div>
                            <div class="form-field">
                                <label data-i18n="settings.children.form.gender">性別</label>
                                <select id="childProfileGender">
                                    <option value="" data-i18n="settings.children.form.gender.unspecified">不透露</option>
                                    <option value="male" data-i18n="settings.children.form.gender.male">男</option>
                                    <option value="female" data-i18n="settings.children.form.gender.female">女</option>
                                    <option value="other" data-i18n="settings.children.form.gender.other">其他</option>
                                </select>
                            </div>
                            <div class="form-field">
                                <label data-i18n="settings.children.form.notes">備註</label>
                                <textarea id="childProfileNotes" rows="3" placeholder="例如：早產、過敏等特殊情況"></textarea>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="form-btn cancel" id="cancelChildForm" data-i18n="alert.cancel">取消</button>
                            <button class="form-btn save" id="saveChildForm" data-i18n="alert.save">保存</button>
                        </div>
                    </div>
                </div>
                
                <!-- Personalization Settings -->
                <div class="settings-content" id="personalizationTab">
                    <div class="settings-header">
                        <h3><i class="fas fa-palette"></i> <span data-i18n="settings.personalization.title">個人化設定</span></h3>
                        <p class="settings-description" data-i18n="settings.personalization.description">自訂您的個人化偏好設定</p>
                    </div>
                    <div class="setting-item">
                        <label data-i18n="settings.personalization.theme">主題模式</label>
                        <div class="theme-selector">
                            <button class="theme-btn active" data-theme="light"><i class="fas fa-sun"></i> <span data-i18n="settings.personalization.theme.light">淺色</span></button>
                            <button class="theme-btn" data-theme="dark"><i class="fas fa-moon"></i> <span data-i18n="settings.personalization.theme.dark">深色</span></button>
                            <button class="theme-btn" data-theme="auto"><i class="fas fa-circle-half-stroke"></i> <span data-i18n="settings.personalization.theme.auto">自動</span></button>
                        </div>
                    </div>
                    <div class="setting-item">
                        <label data-i18n="settings.personalization.language">界面語言</label>
                        <div class="language-grid">
                            <div class="lang-option active" data-lang="zh-TW">
                                <i class="fas fa-font"></i>
                                <span data-i18n="settings.personalization.language.zh-TW">繁體中文</span>
                            </div>
                            <div class="lang-option" data-lang="en">
                                <i class="fas fa-language"></i>
                                <span data-i18n="settings.personalization.language.en">English</span>
                            </div>
                            <div class="lang-option" data-lang="ja">
                                <i class="fas fa-comment-dots"></i>
                                <span data-i18n="settings.personalization.language.ja">日本語</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Advanced Settings -->
                <div class="settings-content" id="advancedTab">
                    <div class="settings-header">
                        <h3><i class="fa-solid fa-key"></i> <span data-i18n="settings.advanced.title">API 金鑰管理</span></h3>
                        <p class="settings-description" data-i18n="settings.advanced.description">管理您的 Google AI API 金鑰</p>
                    </div>
                    <!-- AI Model Selection -->
                    <div class="setting-item">
                        <label data-i18n="settings.advanced.model">AI 模型選擇</label>
                        <div class="model-selection">
                            <select id="aiModelSelect" class="setting-select">
                                <option value="gemini-3-flash-preview" data-i18n="settings.advanced.model.gemini-3-flash">Gemini 3 Flash</option>
                                <option value="gemini-3-pro-preview" data-i18n="settings.advanced.model.gemini-3-pro">Gemini 3 Pro</option>
                            </select>
                        </div>
                    </div>
                    <!-- API Key Management -->
                    <div class="setting-item">
                        <label data-i18n="settings.advanced.api_key">API 金鑰 / API Key</label>
                        <p class="setting-description" style="font-size: 15px;" data-i18n="settings.advanced.api_key.description">您可以添加多個 API 金鑰以分散使用量</p>
                        <div class="api-key-section">
                            <div class="api-key-list" id="apiKeyList">
                                <!-- API keys will be loaded here -->
                            </div>
                            
                            <button class="add-api-key-btn" id="addApiKeyBtn">
                                <i class="fas fa-plus"></i> <span data-i18n="settings.advanced.api_key.add">添加 API 金鑰</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Custom Alert Modal -->
<div id="customAlertModal" class="modal">
    <div class="modal-content custom-modal-mini">
        <p id="customAlertMessage" class="custom-modal-message"></p>
        <button id="customAlertCloseBtn" class="custom-modal-btn primary" data-i18n="alert.confirm">确定</button>
    </div>
</div>

<!-- Custom Confirm Modal -->
<div id="customConfirmModal" class="modal">
    <div class="modal-content custom-modal-mini">
        <p id="customConfirmMessage" class="custom-modal-message"></p>
        <div class="custom-modal-actions">
            <button id="customConfirmOkBtn" class="custom-modal-btn primary" data-i18n="alert.confirm">确定</button>
            <button id="customConfirmCancelBtn" class="custom-modal-btn secondary" data-i18n="alert.cancel">取消</button>
        </div>
    </div>
</div>

<!-- Custom Prompt Modal -->
<div id="customPromptModal" class="modal">
    <div class="modal-content custom-modal-mini">
        <p id="customPromptMessage" class="custom-modal-message"></p>
        <input type="text" id="customPromptInput" class="custom-modal-input">
        <div class="custom-modal-actions">
            <button id="customPromptOkBtn" class="custom-modal-btn primary" data-i18n="alert.confirm">确定</button>
            <button id="customPromptCancelBtn" class="custom-modal-btn secondary" data-i18n="alert.cancel">取消</button>
        </div>
    </div>
</div>

<!-- Webcam Modal -->
<div id="webcamModal" class="modal">
    <div class="modal-content">
        <span class="close-webcam">&times;</span>
        <h2>Webcam Input</h2>
        <video id="webcamFeed" autoplay style="width: 100%; border-radius: 8px;"></video>
        <button id="captureBtn" class="sidebar-btn" style="width: 100%; margin-top: 10px;"><i class="fas fa-camera"></i> Capture & Send</button>
    </div>
</div>

<!-- API Key Modal -->
<div id="apiKeyModal" class="modal">
    <div class="modal-content custom-modal-mini">
        <h2 data-i18n="api_key_modal.title">添加 API 金鑰</h2>
        <div class="api-key-form">
            <div class="form-group">
                <input type="text" id="apiKeyName" class="custom-modal-input" placeholder="金鑰名稱 (例如：My Gemini Key)" required>
            </div>
            
            <div class="form-group">
                <input type="password" id="apiKeyValue" class="custom-modal-input" placeholder="輸入您的 Google AI API 金鑰" required>
                <small class="form-hint" style="display: block; text-align: center; margin-bottom: 20px; color: #8B7AA8; font-weight: 600;" data-i18n="api_key_modal.hint">您的 API 金鑰將被加密存儲</small>
            </div>
            
            <div class="custom-modal-actions">
                <button id="saveApiKeyBtn" class="custom-modal-btn primary">
                    <i class="fas fa-save"></i> <span data-i18n="api_key_modal.save">保存</span>
                </button>
                <button id="cancelApiKeyBtn" class="custom-modal-btn secondary">
                    <i class="fas fa-times"></i> <span data-i18n="api_key_modal.cancel">取消</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Username Modal -->
<div id="editUsernameModal" class="modal">
    <div class="modal-content custom-modal-mini">
        <h2 data-i18n="settings.profile.edit_username">編輯用戶名稱</h2>
        <div class="form-group">
            <input type="text" id="editUsernameInput" class="custom-modal-input" placeholder="輸入新的用戶名稱" required>
        </div>
        <div class="custom-modal-actions">
            <button id="saveUsernameBtn" class="custom-modal-btn primary">
                <i class="fas fa-save"></i> <span data-i18n="settings.profile.save">保存</span>
            </button>
            <button id="cancelUsernameBtn" class="custom-modal-btn secondary">
                <i class="fas fa-times"></i> <span data-i18n="settings.profile.cancel">取消</span>
            </button>
        </div>
    </div>
</div>

<!-- Edit Email Modal -->
<div id="editEmailModal" class="modal">
    <div class="modal-content custom-modal-mini">
        <h2 data-i18n="settings.profile.edit_email">編輯電子郵件</h2>
        <div class="form-group">
            <input type="email" id="editEmailInput" class="custom-modal-input" placeholder="輸入新的電子郵件地址" required>
        </div>
        <div class="custom-modal-actions">
            <button id="saveEmailBtn" class="custom-modal-btn primary">
                <i class="fas fa-save"></i> <span data-i18n="settings.profile.save">保存</span>
            </button>
            <button id="cancelEmailBtn" class="custom-modal-btn secondary">
                <i class="fas fa-times"></i> <span data-i18n="settings.profile.cancel">取消</span>
            </button>
        </div>
    </div>
</div>

<!-- Change Password Modal -->
<div id="changePasswordModal" class="modal">
    <div class="modal-content custom-modal-mini">
        <h2 data-i18n="settings.profile.change_password">變更密碼</h2>
        <div class="form-group">
            <div class="custom-modal-input-group">
                <input type="password" id="oldPasswordInput" class="custom-modal-input" placeholder="輸入舊密碼" required>
                <button type="button" id="oldPasswordToggle" class="custom-modal-toggle" aria-label="Toggle password visibility">
                    <i class="fas fa-eye"></i>
                </button>
            </div>
            <div class="custom-modal-input-group">
                <input type="password" id="newPasswordInput" class="custom-modal-input" placeholder="輸入新密碼" required>
                <button type="button" id="newPasswordToggle" class="custom-modal-toggle" aria-label="Toggle password visibility">
                    <i class="fas fa-eye"></i>
                </button>
            </div>
            <div class="custom-modal-input-group">
                <input type="password" id="confirmPasswordInput" class="custom-modal-input" placeholder="再次輸入新密碼" required>
                <button type="button" id="confirmPasswordToggle" class="custom-modal-toggle" aria-label="Toggle password visibility">
                    <i class="fas fa-eye"></i>
                </button>
            </div>
        </div>
        <div class="custom-modal-actions">
            <button id="savePasswordBtn" class="custom-modal-btn primary">
                <i class="fas fa-save"></i> <span data-i18n="settings.profile.save">保存</span>
            </button>
            <button id="cancelPasswordBtn" class="custom-modal-btn secondary">
                <i class="fas fa-times"></i> <span data-i18n="settings.profile.cancel">取消</span>
            </button>
        </div>
    </div>
</div>

<!-- Delete Account Modal -->
<div id="deleteAccountModal" class="modal">
    <div class="modal-content custom-modal-mini">
        <h2 data-i18n="settings.profile.delete_account">刪除帳號</h2>
        <div class="custom-modal-input-group">
            <input type="password" id="deleteAccountPasswordInput" class="custom-modal-input" placeholder="輸入密碼" required>
            <button type="button" id="deleteAccountToggle" class="custom-modal-toggle" aria-label="Toggle password visibility">
                <i class="fas fa-eye"></i>
            </button>
        </div>
        <div class="custom-modal-actions">
            <button id="confirmDeleteAccountBtn" class="custom-modal-btn delete-btn" style="background-color: #b00020; color: white;">
                <i class="fas fa-trash"></i> <span data-i18n="settings.profile.delete_account.confirm_btn">確認刪除</span>
            </button>
            <button id="cancelDeleteAccountBtn" class="custom-modal-btn secondary">
                <i class="fas fa-times"></i> <span data-i18n="settings.profile.cancel">取消</span>
            </button>
        </div>
    </div>
</div>