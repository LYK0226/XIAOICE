<!-- Profile Settings Modal -->
<div id="avatarModal" class="modal">
    <div class="modal-content settings-modal">
        <div class="settings-layout">
            <!-- Left Sidebar with Groups -->
            <div class="settings-sidebar">
                <span class="close-avatar">&times;</span>
                <div class="settings-group active" data-group="avatar">
                    <i class="fas fa-user-circle"></i>
                    <span data-i18n="settings.profile">個人資料</span>
                </div>
                <div class="settings-group" data-group="children">
                    <i class="fas fa-child"></i>
                    <span data-i18n="settings.children">小朋友</span>
                </div>
                <div class="settings-group" data-group="personalization">
                    <i class="fas fa-palette"></i>
                    <span data-i18n="settings.personalization">個人化</span>
                </div>
                <div class="settings-group" data-group="advanced">
                    <i class="fa-solid fa-key"></i>
                    <span data-i18n="settings.advanced">高級</span>
                </div>
            </div>
            
            <!-- Right Panel with Options -->
            <div class="settings-panel">
                <!-- Profile Settings -->
                <div class="settings-content active" id="avatarTab">
                    <div class="settings-header">
                        <h3><i class="fas fa-user-circle"></i> <span data-i18n="settings.profile.title">個人資料</span></h3>
                        <p class="settings-description" data-i18n="settings.profile.description">管理您的個人資料和帳戶設定</p>
                    </div>
                    <div class="profile-settings">
                        <!-- Avatar Field -->
                        <div class="profile-item">
                            <label class="field-label" data-i18n="settings.profile.avatar">頭像</label>
                            <div class="field-content">
                                <div class="avatar-preview" id="userAvatarPreview">
                                    <i class="fas fa-user"></i>
                                </div>
                                <input type="file" id="userAvatarInput" accept="image/*" style="display: none;">
                            </div>
                            <div class="field-actions">
                                <button class="edit-btn" onclick="document.getElementById('userAvatarInput').click()">
                                    <i class="fas fa-edit"></i> <span data-i18n="settings.profile.edit">編輯</span>
                                </button>
                                <button class="clear-btn" id="clearUserAvatar">
                                    <i class="fas fa-times"></i> <span data-i18n="settings.profile.clear">清除</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Username Field -->
                        <div class="profile-item">
                            <label class="field-label" data-i18n="settings.profile.username">用戶名稱</label>
                            <div class="field-content">
                                <input type="text" id="profileUsername" readonly>
                            </div>
                            <div class="field-actions">
                                <button class="edit-btn" id="editUsernameBtn">
                                    <i class="fas fa-edit"></i> <span data-i18n="settings.profile.edit">編輯</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Email Field -->
                        <div class="profile-item">
                            <label class="field-label" data-i18n="settings.profile.email">電子郵件</label>
                            <div class="field-content">
                                <input type="email" id="profileEmail" readonly>
                            </div>
                            <div class="field-actions">
                                <button class="edit-btn" id="editEmailBtn">
                                    <i class="fas fa-edit"></i> <span data-i18n="settings.profile.edit">編輯</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Password Field -->
                        <div class="profile-item">
                            <label class="field-label" data-i18n="settings.profile.password">密碼</label>
                            <div class="field-content">
                                <input type="password" id="profilePassword" placeholder="********" readonly>
                            </div>
                            <div class="field-actions">
                                <button class="edit-btn" id="editPasswordBtn">
                                    <i class="fas fa-edit"></i> <span data-i18n="settings.profile.edit">編輯</span>
                                </button>
                            </div>
                        </div>

                        <!-- Delete Account -->
                        <div class="profile-item">
                            <label class="field-label" data-i18n="settings.profile.delete_account">刪除帳號</label>
                            <div class="field-content">
                                <p style="color:#b00020; font-size:14px; margin: 0;" data-i18n="settings.profile.delete_account.desc">刪除帳號會永久移除您的所有資料，無法復原。</p>
                            </div>
                            <div class="field-actions">
                                <button id="deleteAccountBtn" class="clear-btn">
                                    <i class="fas fa-trash"></i> <span data-i18n="settings.profile.delete_account">刪除帳號</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Children Settings -->
                <div class="settings-content" id="childrenTab">
                    <div class="settings-header">
                        <h3><i class="fas fa-child"></i> <span data-i18n="settings.children.title">小朋友資料</span></h3>
                        <p class="settings-description" data-i18n="settings.children.description">管理小朋友的基本資料，用於評估和追蹤發展進度</p>
                    </div>
                    
                    <!-- Children List -->
                    <div class="setting-item">
                        <div class="children-list" id="childrenList">
                            <!-- Children will be loaded here dynamically -->
                            <div class="children-empty" id="childrenEmpty" style="display: none;">
                                <i class="fas fa-child" style="font-size: 48px; opacity: 0.3; margin-bottom: 12px;"></i>
                                <p data-i18n="settings.children.empty">尚未添加小朋友資料</p>
                                <p style="font-size: 14px; opacity: 0.7; margin-top: 8px;" data-i18n="settings.children.empty.hint">點擊下方按鈕添加第一筆資料</p>
                            </div>
                        </div>
                        
                        <button class="add-api-key-btn" id="addChildBtn" style="margin-top: 16px;">
                            <i class="fas fa-plus"></i> <span data-i18n="settings.children.add">添加小朋友</span>
                        </button>
                    </div>
                    
                </div>
                
                <!-- Personalization Settings -->
                <div class="settings-content" id="personalizationTab">
                    <div class="settings-header">
                        <h3><i class="fas fa-palette"></i> <span data-i18n="settings.personalization.title">個人化設定</span></h3>
                        <p class="settings-description" data-i18n="settings.personalization.description">自訂您的個人化偏好設定</p>
                    </div>
                    <div class="setting-item">
                        <label data-i18n="settings.personalization.theme">主題模式</label>
                        <div class="theme-selector">
                            <button class="theme-btn active" data-theme="light"><i class="fas fa-sun"></i> <span data-i18n="settings.personalization.theme.light">淺色</span></button>
                            <button class="theme-btn" data-theme="dark"><i class="fas fa-moon"></i> <span data-i18n="settings.personalization.theme.dark">深色</span></button>
                            <button class="theme-btn" data-theme="auto"><i class="fas fa-circle-half-stroke"></i> <span data-i18n="settings.personalization.theme.auto">自動</span></button>
                        </div>
                    </div>
                    <div class="setting-item">
                        <label data-i18n="settings.personalization.language">界面語言</label>
                        <div class="language-grid">
                            <div class="lang-option active" data-lang="zh-TW">
                                <i class="fas fa-font"></i>
                                <span>繁體中文</span>
                            </div>
                            <div class="lang-option" data-lang="zh-CN">
                                <i class="fas fa-font"></i>
                                <span>简体中文</span>
                            </div>
                            <div class="lang-option" data-lang="en">
                                <i class="fas fa-language"></i>
                                <span>English</span>
                            </div>
                            <div class="lang-option" data-lang="ja">
                                <i class="fas fa-comment-dots"></i>
                                <span>日本語</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Advanced Settings -->
                <div class="settings-content" id="advancedTab">
                    <div class="settings-header">
                        <h3><i class="fa-solid fa-key"></i> <span data-i18n="settings.advanced.title">API 金鑰管理</span></h3>
                        <p class="settings-description" data-i18n="settings.advanced.description">管理您的 Google AI API 金鑰</p>
                    </div>

                    <div class="setting-item advanced-summary" id="advancedSummary">
                        <label data-i18n="settings.advanced.summary.title">目前設定</label>
                        <div class="advanced-summary-grid">
                            <div class="summary-block">
                                <div class="summary-title" data-i18n="settings.advanced.summary.model">已選擇模型</div>
                                <div class="summary-value" id="advancedSelectedModel">-</div>
                                <div class="summary-sub" id="advancedSelectedProvider">-</div>
                                <div class="summary-controls">
                                    <div class="summary-control">
                                        <span class="summary-control-label" data-i18n="settings.advanced.provider">AI 提供商</span>
                                        <div class="summary-provider-toggle" id="summaryProviderToggle">
                                            <button type="button" class="summary-provider-btn" data-provider="ai_studio" data-i18n="settings.advanced.provider.ai_studio">AI Studio (Gemini API)</button>
                                            <button type="button" class="summary-provider-btn" data-provider="vertex_ai" data-i18n="settings.advanced.provider.vertex_ai">Vertex AI (Service Account)</button>
                                        </div>
                                    </div>
                                    <div class="summary-control">
                                        <span class="summary-control-label" data-i18n="settings.advanced.model">AI 模型選擇</span>
                                        <select id="summaryModelSelect" class="setting-select summary-select"></select>
                                    </div>
                                    <div class="summary-control">
                                        <span class="summary-control-label" data-i18n="settings.advanced.api_key">API 金鑰</span>
                                        <select id="summaryApiKeySelect" class="setting-select summary-select"></select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button class="add-api-key-btn" id="showAdvancedConfigBtn">
                            <i class="fas fa-cog"></i> <span data-i18n="settings.advanced.manage_config">管理配置</span>
                        </button>
                    </div>

                    <div class="advanced-config-details" id="advancedConfigDetails" style="display: none;">
                    
                    <!-- Configuration List -->
                    <div class="setting-item" id="configListSection">
                        <label data-i18n="settings.advanced.config_list">已添加的配置</label>
                        <p class="setting-description" style="font-size: 15px; margin-bottom: 12px;" data-i18n="settings.advanced.config_list.description">管理您已添加的 AI Studio 和 Vertex AI 配置</p>
                        <div class="config-list-container" id="configListContainer">
                            <!-- Configuration items will be loaded here -->
                        </div>
                        <button class="add-api-key-btn" id="openAddConfigModalBtn" style="margin-top: 16px;">
                            <i class="fas fa-plus"></i> <span data-i18n="settings.advanced.add_new_config">添加配置</span>
                        </button>
                    </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Custom Alert Modal -->
<div id="customAlertModal" class="modal">
    <div class="modal-content custom-modal-mini">
        <p id="customAlertMessage" class="custom-modal-message"></p>
        <button id="customAlertCloseBtn" class="custom-modal-btn primary" data-i18n="alert.confirm">确定</button>
    </div>
</div>

<!-- Custom Confirm Modal -->
<div id="customConfirmModal" class="modal">
    <div class="modal-content custom-modal-mini">
        <p id="customConfirmMessage" class="custom-modal-message"></p>
        <div class="custom-modal-actions">
            <button id="customConfirmOkBtn" class="custom-modal-btn primary" data-i18n="alert.confirm">确定</button>
            <button id="customConfirmCancelBtn" class="custom-modal-btn secondary" data-i18n="alert.cancel">取消</button>
        </div>
    </div>
</div>

<!-- Custom Prompt Modal -->
<div id="customPromptModal" class="modal">
    <div class="modal-content custom-modal-mini">
        <p id="customPromptMessage" class="custom-modal-message"></p>
        <input type="text" id="customPromptInput" class="custom-modal-input">
        <div class="custom-modal-actions">
            <button id="customPromptOkBtn" class="custom-modal-btn primary" data-i18n="alert.confirm">确定</button>
            <button id="customPromptCancelBtn" class="custom-modal-btn secondary" data-i18n="alert.cancel">取消</button>
        </div>
    </div>
</div>

<!-- Webcam Modal -->
<div id="webcamModal" class="modal">
    <div class="modal-content">
        <span class="close-webcam">&times;</span>
        <h2>Webcam Input</h2>
        <video id="webcamFeed" autoplay style="width: 100%; border-radius: 8px;"></video>
        <button id="captureBtn" class="sidebar-btn" style="width: 100%; margin-top: 10px;"><i class="fas fa-camera"></i> Capture & Send</button>
    </div>
</div>

<!-- Add Configuration Modal -->
<div id="addConfigModal" class="modal">
    <div class="modal-content custom-modal-mini" style="max-width: 600px; width: 90%;">
        <h2 data-i18n="config_modal.title">添加配置</h2>
        
        <!-- Provider Selection Tabs -->
        <div class="config-provider-tabs" style="display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0;">
            <button type="button" class="config-tab-btn active" data-config-provider="ai_studio" style="flex: 1; padding: 12px; border: none; background: transparent; cursor: pointer; border-bottom: 3px solid #8B7AA8; font-weight: 600; color: #8B7AA8;">
                <i class="fas fa-robot"></i> <span data-i18n="settings.advanced.provider.ai_studio">AI Studio</span>
            </button>
            <button type="button" class="config-tab-btn" data-config-provider="vertex_ai" style="flex: 1; padding: 12px; border: none; background: transparent; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 500; color: #666;">
                <i class="fas fa-cloud"></i> <span data-i18n="settings.advanced.provider.vertex_ai">Vertex AI</span>
            </button>
        </div>
        
        <!-- AI Studio Configuration Form -->
        <div class="config-form-content" id="aiStudioConfigForm">
            <div class="form-group">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;" data-i18n="config_modal.ai_studio.name">配置名稱</label>
                <input type="text" id="configAiStudioName" class="custom-modal-input" placeholder="例如：My Gemini Key" required>
            </div>
            
            <div class="form-group">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;" data-i18n="config_modal.ai_studio.api_key">API 金鑰</label>
                <input type="password" id="configAiStudioKey" class="custom-modal-input" placeholder="輸入您的 Google AI API 金鑰" required>
                <small class="form-hint" style="display: block; margin-top: 8px; color: #8B7AA8; font-size: 12px;" data-i18n="config_modal.hint">您的 API 金鑰將被加密存儲</small>
            </div>
        </div>
        
        <!-- Vertex AI Configuration Form -->
        <div class="config-form-content" id="vertexAiConfigForm" style="display: none;">
            <div class="form-group">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;" data-i18n="config_modal.vertex.name">配置名稱</label>
                <input type="text" id="configVertexName" class="custom-modal-input" placeholder="例如：My Vertex Account" required>
            </div>
            
            <div class="form-group">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;" data-i18n="config_modal.vertex.service_account">服務帳戶 JSON</label>
                <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                    <button type="button" id="configVertexUploadBtn" class="add-api-key-btn" style="flex: 1; margin: 0; padding: 10px;">
                        <i class="fas fa-upload"></i> <span data-i18n="config_modal.vertex.upload">上傳檔案</span>
                    </button>
                    <button type="button" id="configVertexClearBtn" class="clear-btn" style="flex: 1; margin: 0; padding: 10px; display: none;">
                        <i class="fas fa-times"></i> <span data-i18n="config_modal.vertex.clear">清除</span>
                    </button>
                </div>
                <input type="file" id="configVertexServiceAccountFile" accept=".json" style="display: none;">
                <input type="hidden" id="configVertexServiceAccount">
                <small class="form-hint" style="display: block; margin-top: 8px; color: #666; font-size: 12px;" data-i18n="config_modal.vertex.hint">從 GCP 主控台下載的服務帳戶 JSON 金鑰文件</small>
                <div id="configVertexProjectIdDisplay" style="display: none; margin-top: 8px; padding: 8px; background: #f0f0f0; border-radius: 4px;">
                    <small style="color: #666; font-size: 12px;"><strong data-i18n="config_modal.vertex.detected_project">檢測到的專案 ID</strong>: <span id="configDetectedProjectId" style="color: #333; font-weight: 600;"></span></small>
                </div>
            </div>
        </div>
        
        <div class="custom-modal-actions" style="margin-top: 24px;">
            <button id="saveConfigBtn" class="custom-modal-btn primary">
                <i class="fas fa-save"></i> <span data-i18n="config_modal.save">保存配置</span>
            </button>
            <button id="cancelConfigBtn" class="custom-modal-btn secondary">
                <i class="fas fa-times"></i> <span data-i18n="config_modal.cancel">取消</span>
            </button>
        </div>
    </div>
</div>

<!-- API Key Modal (Legacy - kept for compatibility) -->
<div id="apiKeyModal" class="modal">
    <div class="modal-content custom-modal-mini">
        <h2 data-i18n="api_key_modal.title">添加 API 金鑰</h2>
        <div class="api-key-form">
            <div class="form-group">
                <input type="text" id="apiKeyName" class="custom-modal-input" placeholder="金鑰名稱 (例如：My Gemini Key)" required>
            </div>
            
            <div class="form-group">
                <input type="password" id="apiKeyValue" class="custom-modal-input" placeholder="輸入您的 Google AI API 金鑰" required>
                <small class="form-hint" style="display: block; text-align: center; margin-bottom: 20px; color: #8B7AA8; font-weight: 600;" data-i18n="api_key_modal.hint">您的 API 金鑰將被加密存儲</small>
            </div>
            
            <div class="custom-modal-actions">
                <button id="saveApiKeyBtn" class="custom-modal-btn primary">
                    <i class="fas fa-save"></i> <span data-i18n="api_key_modal.save">保存</span>
                </button>
                <button id="cancelApiKeyBtn" class="custom-modal-btn secondary">
                    <i class="fas fa-times"></i> <span data-i18n="api_key_modal.cancel">取消</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Username Modal -->
<div id="editUsernameModal" class="modal">
    <div class="modal-content custom-modal-mini">
        <h2 data-i18n="settings.profile.edit_username">編輯用戶名稱</h2>
        <div class="form-group">
            <input type="text" id="editUsernameInput" class="custom-modal-input" placeholder="輸入新的用戶名稱" required>
        </div>
        <div class="custom-modal-actions">
            <button id="saveUsernameBtn" class="custom-modal-btn primary">
                <i class="fas fa-save"></i> <span data-i18n="settings.profile.save">保存</span>
            </button>
            <button id="cancelUsernameBtn" class="custom-modal-btn secondary">
                <i class="fas fa-times"></i> <span data-i18n="settings.profile.cancel">取消</span>
            </button>
        </div>
    </div>
</div>

<!-- Edit Email Modal -->
<div id="editEmailModal" class="modal">
    <div class="modal-content custom-modal-mini">
        <h2 data-i18n="settings.profile.edit_email">編輯電子郵件</h2>
        <div class="form-group">
            <input type="email" id="editEmailInput" class="custom-modal-input" placeholder="輸入新的電子郵件地址" required>
        </div>
        <div class="custom-modal-actions">
            <button id="saveEmailBtn" class="custom-modal-btn primary">
                <i class="fas fa-save"></i> <span data-i18n="settings.profile.save">保存</span>
            </button>
            <button id="cancelEmailBtn" class="custom-modal-btn secondary">
                <i class="fas fa-times"></i> <span data-i18n="settings.profile.cancel">取消</span>
            </button>
        </div>
    </div>
</div>

<!-- Change Password Modal -->
<div id="changePasswordModal" class="modal">
    <div class="modal-content custom-modal-mini">
        <h2 data-i18n="settings.profile.change_password">變更密碼</h2>
        <div class="form-group">
            <div class="custom-modal-input-group">
                <input type="password" id="oldPasswordInput" class="custom-modal-input" placeholder="輸入舊密碼" required>
                <button type="button" id="oldPasswordToggle" class="custom-modal-toggle" aria-label="Toggle password visibility">
                    <i class="fas fa-eye"></i>
                </button>
            </div>
            <div class="custom-modal-input-group">
                <input type="password" id="newPasswordInput" class="custom-modal-input" placeholder="輸入新密碼" required>
                <button type="button" id="newPasswordToggle" class="custom-modal-toggle" aria-label="Toggle password visibility">
                    <i class="fas fa-eye"></i>
                </button>
            </div>
            <div class="custom-modal-input-group">
                <input type="password" id="confirmPasswordInput" class="custom-modal-input" placeholder="再次輸入新密碼" required>
                <button type="button" id="confirmPasswordToggle" class="custom-modal-toggle" aria-label="Toggle password visibility">
                    <i class="fas fa-eye"></i>
                </button>
            </div>
        </div>
        <div class="custom-modal-actions">
            <button id="savePasswordBtn" class="custom-modal-btn primary">
                <i class="fas fa-save"></i> <span data-i18n="settings.profile.save">保存</span>
            </button>
            <button id="cancelPasswordBtn" class="custom-modal-btn secondary">
                <i class="fas fa-times"></i> <span data-i18n="settings.profile.cancel">取消</span>
            </button>
        </div>
    </div>
</div>

<!-- Delete Account Modal -->
<div id="deleteAccountModal" class="modal">
    <div class="modal-content custom-modal-mini">
        <h2 data-i18n="settings.profile.delete_account">刪除帳號</h2>
        <div class="custom-modal-input-group">
            <input type="password" id="deleteAccountPasswordInput" class="custom-modal-input" placeholder="輸入密碼" required>
            <button type="button" id="deleteAccountToggle" class="custom-modal-toggle" aria-label="Toggle password visibility">
                <i class="fas fa-eye"></i>
            </button>
        </div>
        <div class="custom-modal-actions">
            <button id="confirmDeleteAccountBtn" class="custom-modal-btn delete-btn" style="background-color: #b00020; color: white;">
                <i class="fas fa-trash"></i> <span data-i18n="settings.profile.delete_account.confirm_btn">確認刪除</span>
            </button>
            <button id="cancelDeleteAccountBtn" class="custom-modal-btn secondary">
                <i class="fas fa-times"></i> <span data-i18n="settings.profile.cancel">取消</span>
            </button>
        </div>
    </div>
</div>

<!-- Add/Edit Child Modal -->
<div id="childModal" class="modal">
    <div class="modal-content custom-modal-mini" style="max-width: 500px; width: 90%;">
        <h2 id="childModalTitle" data-i18n="settings.children.form.add">添加小朋友</h2>
        
        <div class="form-group" style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500;" data-i18n="settings.children.form.name">姓名 *</label>
            <input type="text" id="childModalName" class="custom-modal-input" placeholder="例如：小明" required>
        </div>
        
        <div class="form-group" style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500;" data-i18n="settings.children.form.birthdate">出生日期 *</label>
            <input type="date" id="childModalBirthdate" class="custom-modal-input" required style="cursor: pointer;">
        </div>
        
        <div class="form-group" style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500;" data-i18n="settings.children.form.gender">性別</label>
            <select id="childModalGender" class="custom-modal-input">
                <option value="" data-i18n="settings.children.form.gender.unspecified">不透露</option>
                <option value="male" data-i18n="settings.children.form.gender.male">男</option>
                <option value="female" data-i18n="settings.children.form.gender.female">女</option>
                <option value="other" data-i18n="settings.children.form.gender.other">其他</option>
            </select>
        </div>
        
        <div class="form-group" style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500;" data-i18n="settings.children.form.notes">備註</label>
            <textarea id="childModalNotes" class="custom-modal-input" rows="3" placeholder="例如：早產、過敏等特殊情況" style="resize: vertical; min-height: 80px; padding: 12px;"></textarea>
        </div>
        
        <div class="custom-modal-actions" style="margin-top: 24px;">
            <button id="saveChildModalBtn" class="custom-modal-btn primary">
                <i class="fas fa-save"></i> <span data-i18n="alert.save">保存</span>
            </button>
            <button id="cancelChildModalBtn" class="custom-modal-btn secondary">
                <i class="fas fa-times"></i> <span data-i18n="alert.cancel">取消</span>
            </button>
        </div>
    </div>
</div>