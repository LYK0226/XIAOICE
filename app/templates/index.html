<!DOCTYPE html>
<html lang="zh-tw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠå¤©ç›’å­ - Chatbox</title>
    <!-- Main chat interface styles -->
    <link rel="stylesheet" href="../static/css/chatbox.css">
    <!-- Sidebar styles -->
    <link rel="stylesheet" href="../static/css/sidebar.css">
    <!-- Settings modal styles -->
    <link rel="stylesheet" href="../static/css/settings.css">
    <!-- Assessment styles -->
    <link rel="stylesheet" href="../static/css/assessment.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div id="sidebar" style="display: none;">
        <div class="sidebar-header">
            <button class="sidebar-toggle" id="sidebarToggle"><i class="fas fa-bars"></i></button>
            <i class="fas fa-comment"></i>
            <h2>èŠå¤©ç›’å­</h2>
        </div>
        
        <div class="sidebar-section">
            <h3>èŠå¤©</h3>
            <ul class="chat-list">
                <li class="empty-state">è¼‰å…¥ä¸­...</li>
            </ul>
        </div>
        
        <div class="sidebar-footer">
            <button class="sidebar-btn" id="newChat"><i class="fas fa-plus"></i> æ–°å°è©±</button>
            <button class="sidebar-btn" id="childAssessment"><i class="fas fa-clipboard-list"></i> å…’ç«¥è©•ä¼°</button>
            <button class="sidebar-btn" id="settings"><i class="fas fa-cog"></i> è¨­å®š</button>
            <button class="sidebar-btn" id="logout"><i class="fas fa-sign-out-alt"></i> ç™»å‡º</button>
        </div>
    </div>
    
    <div id="main-content" style="margin-left: 0;">
        <!-- Chat Container -->
        <div id="chat-container" style="display: none;">
            <div id="chat-header">
                <div class="chat-title">
                    <button class="sidebar-show-btn" id="sidebarShowBtn" style="display: none;"><i class="fas fa-bars"></i></button>
                    <i class="fas fa-comment"></i>
                    <span>èŠå¤©ç›’å­</span>
                </div>
                <div class="chat-actions">
                    <button class="icon-btn"><i class="fas fa-search"></i></button>
                    <button class="icon-btn"><i class="fas fa-user-circle"></i></button>
                    <button class="icon-btn"><i class="fas fa-ellipsis-h"></i></button>
                </div>
            </div>
            
            <div id="messages">
                <div class="bot-message-container">
                    <div class="avatar bot-avatar" id="botDogAvatar">
                        <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                            <!-- Left Ear (Orange with pink inner) -->
                            <g class="dog-left-ear">
                                <ellipse cx="25" cy="15" rx="10" ry="18" fill="#E8A76D" stroke="#1a1a1a" stroke-width="1.5"/>
                                <ellipse cx="25" cy="17" rx="6" ry="14" fill="#FFB3A8" stroke="none"/>
                            </g>
                            
                            <!-- Right Ear (Orange with pink inner) -->
                            <g class="dog-right-ear">
                                <ellipse cx="75" cy="15" rx="10" ry="18" fill="#E8A76D" stroke="#1a1a1a" stroke-width="1.5"/>
                                <ellipse cx="75" cy="17" rx="6" ry="14" fill="#FFB3A8" stroke="none"/>
                            </g>
                            
                            <!-- Head (White) -->
                            <circle cx="50" cy="50" r="32" fill="#FFFFFF" stroke="#1a1a1a" stroke-width="1.5"/>
                            
                            <!-- Orange patches (side of head) -->
                            <ellipse cx="28" cy="45" rx="12" ry="14" fill="#E8A76D" stroke="none"/>
                            <ellipse cx="72" cy="45" rx="12" ry="14" fill="#E8A76D" stroke="none"/>
                            
                            <!-- Eyes (Large black with white highlight) -->
                            <circle class="dog-eyes" cx="36" cy="44" r="6" fill="#1a1a1a" stroke="#000" stroke-width="0.5"/>
                            <circle cx="37" cy="42" r="2" fill="#FFF"/>
                            
                            <circle class="dog-eyes" cx="64" cy="44" r="6" fill="#1a1a1a" stroke="#000" stroke-width="0.5"/>
                            <circle cx="65" cy="42" r="2" fill="#FFF"/>
                            
                            <!-- Black nose -->
                            <ellipse cx="50" cy="58" rx="5" ry="6" fill="#1a1a1a" stroke="#000" stroke-width="0.5"/>
                            
                            <!-- Mouth area (smile) -->
                            <path class="dog-mouth" d="M 50 60 Q 45 68 40 66" stroke="#1a1a1a" stroke-width="2" fill="none" stroke-linecap="round"/>
                            <path class="dog-mouth" d="M 50 60 Q 55 68 60 66" stroke="#1a1a1a" stroke-width="2" fill="none" stroke-linecap="round"/>
                            
                            <!-- Tongue (pink, out when talking) -->
                            <ellipse class="dog-mouth" cx="50" cy="72" rx="4" ry="5" fill="#FFB3A8" stroke="#FF8FA3" stroke-width="0.5"/>
                            
                            <!-- Paw pads (cute detail) -->
                            <circle cx="20" cy="80" r="2.5" fill="#FFB3A8" stroke="#1a1a1a" stroke-width="0.5"/>
                            <circle cx="80" cy="80" r="2.5" fill="#FFB3A8" stroke="#1a1a1a" stroke-width="0.5"/>
                        </svg>
                    </div>
                    <div class="message-content">
                        <p>æ±ªæ±ªï¼æˆ‘æ˜¯æ‚¨çš„ç‹—ç‹—åŠ©ç†ï¼æˆ‘å¾ˆé«˜èˆˆèªè­˜æ‚¨ã€‚æˆ‘å¯ä»¥å›ç­”æ‚¨çš„å•é¡Œï¼Œå¹«åŠ©æ‚¨å­¸ç¿’ã€‚æœ‰ä»€éº¼æˆ‘å¯ä»¥å¹«åŠ©æ‚¨çš„å—ï¼Ÿ</p>
                    </div>
                </div>
            </div>
            
            <div id="input-container">
                <div class="input-toolbar">
                    <button class="toolbar-btn" id="fileUploadBtn" title="é™„åŠ æ–‡ä»¶/åœ–åƒ" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"><i class="fas fa-paperclip"></i></button>
                    <button class="toolbar-btn" id="assessmentBtn" title="é–‹å§‹è©•ä¼°" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);"><i class="fas fa-clipboard-list"></i></button>
                    <button class="toolbar-btn" id="videoUploadBtn" title="ä¸Šè¼‰å½±ç‰‡" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);"><i class="fas fa-video"></i></button>
                    <button class="toolbar-btn" id="emojiBtn" title="è¡¨æƒ…ç¬¦è™Ÿ" style="background: linear-gradient(135deg, #ffd89b 0%, #ff6b6b 100%);"><i class="fas fa-smile"></i></button>
                    <button class="toolbar-btn" id="voiceInputBtn" title="èªéŸ³è¼¸å…¥" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);"><i class="fas fa-microphone"></i></button>
                    <button class="toolbar-btn" id="webcamBtn" title="æ”å½±æ©Ÿ" style="background: linear-gradient(135deg, #ff9a56 0%, #ff6a88 100%);"><i class="fas fa-camera"></i></button>
                </div>
                <div class="input-wrapper">
                    <input type="text" id="messageInput" placeholder="åœ¨é€™è£¡è¼¸å…¥æ‚¨çš„å•é¡Œ...">
                    <input type="file" id="fileInput" accept="image/*,application/pdf,.doc,.docx,.txt" multiple style="display: none;">
                    <button id="sendButton"><i class="fas fa-paper-plane"></i></button>
                </div>
                
                <!-- File Preview Container -->
                <div id="filePreviewContainer" class="file-preview-container" style="display: none;"></div>
                
                <!-- Emoji Picker -->
                <div id="emojiPicker" class="emoji-picker" style="display: none;">
                    <div class="emoji-header">
                        <span class="emoji-tab active" data-category="smileys">ğŸ˜Š</span>
                        <span class="emoji-tab" data-category="gestures">ğŸ‘‹</span>
                        <span class="emoji-tab" data-category="animals">ğŸ±</span>
                        <span class="emoji-tab" data-category="food">ğŸ•</span>
                        <span class="emoji-tab" data-category="activities">âš½</span>
                        <span class="emoji-tab" data-category="travel">âœˆï¸</span>
                        <span class="emoji-tab" data-category="objects">ğŸ’¡</span>
                        <span class="emoji-tab" data-category="symbols">â¤ï¸</span>
                    </div>
                    <div class="emoji-content" id="emojiContent"></div>
                </div>
                
                <!-- Webcam Modal -->
                <div id="webcamModal" class="webcam-modal" style="display: none;">
                    <div class="webcam-content">
                        <div class="webcam-header">
                            <h3>æ‹ç…§</h3>
                            <button class="close-webcam" id="closeWebcam">&times;</button>
                        </div>
                        <div class="webcam-body">
                            <video id="webcamVideo" autoplay playsinline></video>
                            <canvas id="webcamCanvas" style="display: none;"></canvas>
                        </div>
                        <div class="webcam-footer">
                            <button class="webcam-action-btn" id="captureBtn"><i class="fas fa-camera"></i> æ‹ç…§</button>
                            <button class="webcam-action-btn" id="retakeBtn" style="display: none;"><i class="fas fa-redo"></i> é‡æ‹</button>
                            <button class="webcam-action-btn primary" id="usePhotoBtn" style="display: none;"><i class="fas fa-check"></i> ä½¿ç”¨ç…§ç‰‡</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Document Preview Panel -->
        <div id="preview-panel" class="preview-panel" style="display: none;">
            <div class="preview-header">
                <h3 id="preview-title">Document Preview</h3>
                <button class="close-preview" id="closePreview">&times;</button>
            </div>
            <div class="preview-content" id="preview-content">
                <!-- Preview content will be inserted here -->
            </div>
        </div>

        <!-- Video Management Modal -->
        <div id="videoModal" class="video-modal" style="display: none;">
            <div class="video-modal-content">
                <div class="video-modal-header">
                    <h2>å½±ç‰‡ä¸Šè¼‰èˆ‡åˆ†æ</h2>
                    <button class="close-video-modal" id="closeVideoModal">&times;</button>
                </div>
                
                <div class="video-modal-body">
                    <!-- Upload Section -->
                    <div class="video-upload-section">
                        <h3>ä¸Šè¼‰å½±ç‰‡</h3>
                        <div class="video-upload-zone" id="videoUploadZone">
                            <i class="fas fa-video"></i>
                            <p>æ‹–æ”¾å½±ç‰‡åˆ°æ­¤è™•æˆ–é»æ“Šä¸Šå‚³</p>
                            <small>æ”¯æ´æ ¼å¼: MP4, AVI, MOV, MKV, WebM, FLV, WMV (æœ€å¤§ 500MB)</small>
                        </div>
                        <input type="file" id="videoInput" accept="video/*,audio/*" style="display: none;">
                        
                        <div id="uploadProgress" style="display: none; margin-top: 15px;">
                            <div class="progress-bar">
                                <div class="progress-fill"></div>
                            </div>
                            <p id="uploadStatus">ä¸Šè¼‰ä¸­...</p>
                        </div>
                    </div>

                    <!-- Video List Section -->
                    <div class="video-list-section" style="margin-top: 30px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0;">å·²ä¸Šè¼‰çš„å½±ç‰‡</h3>
                            <button id="clearAllVideosBtn" class="btn btn-danger" style="padding: 8px 15px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; display: none;">
                                <i class="fas fa-trash-alt"></i> æ¸…é™¤æ‰€æœ‰å½±ç‰‡
                            </button>
                        </div>
                        <div id="videoList" class="video-list">
                            <p class="empty-state">å°šç„¡å½±ç‰‡</p>
                        </div>
                    </div>

                    <!-- Video Details Section -->
                    <div id="videoDetails" class="video-details-section" style="display: none; margin-top: 30px;">
                        <h3>å½±ç‰‡è©³æƒ…</h3>
                        
                        <!-- Video Player -->
                        <div class="video-player-section" style="margin-bottom: 25px;">
                            <video id="videoPlayer" class="video-player" controls style="width: 100%; max-height: 500px; border-radius: 12px; background: #000;">
                                <source id="videoSource" type="video/mp4">
                                æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´è¦–é »æ’­æ”¾
                            </video>
                        </div>
                        
                        <div class="video-detail-container">
                            <div class="detail-row">
                                <span class="detail-label">æª”å:</span>
                                <span class="detail-value" id="detailFileName"></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">æª”æ¡ˆå¤§å°:</span>
                                <span class="detail-value" id="detailFileSize"></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">æ™‚é•·:</span>
                                <span class="detail-value" id="detailDuration"></span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">è½‰éŒ„ç‹€æ…‹:</span>
                                <span class="detail-value" id="detailTranscriptionStatus">
                                    <span id="transcriptionStatusBadge" class="status-badge">ç­‰å¾…ä¸­</span>
                                </span>
                            </div>
                        </div>

                        <!-- Real-time Transcription Progress -->
                        <div style="margin-top: 25px; padding: 15px; background: #f0f4ff; border-radius: 10px; border-left: 4px solid #667eea;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <i class="fas fa-microphone" style="color: #667eea; font-size: 18px;"></i>
                                <h4 style="margin: 0; color: #667eea;">è½‰éŒ„é€²åº¦</h4>
                                <span id="transcriptionPercentage" style="color: #667eea; font-weight: bold; margin-left: auto;">0%</span>
                            </div>
                            <div class="transcription-progress-bar">
                                <div id="transcriptionProgressFill" class="transcription-progress-fill" style="width: 0%;"></div>
                            </div>
                            <p id="transcriptionProgressText" style="margin: 8px 0 0 0; color: #667eea; font-size: 13px;">ç­‰å¾…é–‹å§‹è½‰éŒ„...</p>
                        </div>

                        <!-- Transcription -->
                        <div style="margin-top: 25px;">
                            <h4>
                                <i class="fas fa-file-alt" style="margin-right: 8px; color: #667eea;"></i>
                                è½‰éŒ„æ–‡æœ¬
                                <span id="wordCount" style="font-size: 12px; color: #999; font-weight: normal; margin-left: 10px;">0 å­—</span>
                            </h4>
                            <div id="transcriptionContainer" class="transcription-container">
                                <p id="transcriptionText" style="color: #999;">å°šæœªè½‰éŒ„</p>
                            </div>
                        </div>

                        <!-- Timestamps -->
                        <div style="margin-top: 25px;">
                            <h4>
                                <i class="fas fa-list" style="margin-right: 8px; color: #667eea;"></i>
                                æ™‚é–“æˆ³è¨˜ (æ¯åˆ†é˜åˆ†æ®µ)
                            </h4>
                            <div id="timestampsContainer" class="timestamps-container">
                                <p>æœªæœ‰æ™‚é–“æˆ³è¨˜</p>
                            </div>
                        </div>

                        <!-- Analysis Report -->
                        <div style="margin-top: 25px;">
                            <h4>
                                <i class="fas fa-brain" style="margin-right: 8px; color: #667eea;"></i>
                                AI åˆ†æå ±å‘Š
                            </h4>
                            <div id="analysisContainer" class="analysis-container">
                                <p>æœªæœ‰åˆ†æ</p>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="video-action-buttons" style="margin-top: 30px;">
                            <button id="analyzeVideoBtn" class="btn btn-primary"><i class="fas fa-brain"></i> é–‹å§‹åˆ†æ</button>
                            <button id="pauseAnalysisBtn" class="btn btn-warning" style="display: none;"><i class="fas fa-pause"></i> æš«åœåˆ†æ</button>
                            <button id="resumeAnalysisBtn" class="btn btn-info" style="display: none;"><i class="fas fa-play"></i> ç¹¼çºŒåˆ†æ</button>
                            <button id="downloadReportBtn" class="btn btn-secondary"><i class="fas fa-download"></i> ä¸‹è¼‰å ±å‘Š</button>
                            <button id="deleteVideoBtn" class="btn btn-danger"><i class="fas fa-trash"></i> åˆªé™¤å½±ç‰‡</button>
                            <button id="backToListBtn" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> è¿”å›åˆ—è¡¨</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Assessment Container (é»˜èªé¡¯ç¤º) -->
    <div id="assessment-container" style="display: flex;">
        <!-- å·¦å´é‚Šæ¬„ -->
        <div class="assessment-sidebar">
            <div class="assessment-sidebar-item">
                <div class="assessment-sidebar-icon">
                    <i class="fas fa-book"></i>
                </div>
                <div class="assessment-sidebar-label">Study Materials</div>
            </div>
            
            <div class="assessment-sidebar-item active">
                <div class="assessment-sidebar-icon">
                    <i class="fas fa-clipboard-list"></i>
                </div>
                <div class="assessment-sidebar-label">Assessments</div>
            </div>
            
            <div class="assessment-sidebar-item">
                <div class="assessment-sidebar-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="assessment-sidebar-label">Progress</div>
            </div>
            
            <div class="assessment-sidebar-item">
                <div class="assessment-sidebar-icon">
                    <i class="fas fa-cog"></i>
                </div>
                <div class="assessment-sidebar-label">Settings</div>
            </div>
        </div>

        <!-- ä¸»å…§å®¹å€åŸŸ -->
        <div class="assessment-content-area">
            <!-- è²“é ­é·¹è£é£¾ -->
            <div class="owl-decoration">ğŸ¦‰</div>
            
            <!-- Assessment Main -->
            <div class="assessment-main" id="assessmentMain">
                <!-- Start Screen -->
                <div id="startScreen">
                    <div class="new-start-card">
                        <h1 class="new-card-title">Start New Assessment</h1>
                        
                        <div class="new-upload-options">
                            <!-- Upload PDF -->
                            <div class="new-upload-item" onclick="handleUploadPDF()">
                                <div class="new-upload-icon">
                                    <i class="fas fa-file-lines"></i>
                                </div>
                                <div class="new-upload-label">Upload PDF</div>
                                <input type="file" id="pdfInput" accept=".pdf" class="hidden">
                            </div>

                            <!-- Upload Video -->
                            <div class="new-upload-item" onclick="showEvaluationModal()">
                                <div class="new-upload-icon">
                                    <i class="fas fa-video"></i>
                                </div>
                                <div class="new-upload-label">
                                    Upload Video / YouTube Link<br>
                                    <small>(for movement evaluation)</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- åº•éƒ¨æŒ‰éˆ• -->
                        <div class="bottom-buttons">
                            <button class="bottom-btn" onclick="handleUploadPDF()">
                                <i class="fas fa-file-pdf"></i> Upload PDF
                            </button>
                            <button class="bottom-btn primary" onclick="showEvaluationModal()">
                                Start Assessment
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Begin Evaluation Modal -->
                <div id="evaluationModal" class="evaluation-modal" style="display: none;">
                    <div class="modal-content-evaluation">
                        <h2 class="modal-title">Begin Evaluation</h2>
                        
                        <div class="modal-form">
                            <label class="modal-label">Select Assessment Type</label>
                            <select class="modal-input" id="assessmentType" onchange="updateAssessmentInfo()">
                                <option value="">Choose assessment...</option>
                            </select>
                            
                            <div id="assessmentInfoBox" class="assessment-info-box" style="display: none;">
                                <div class="info-row">
                                    <span class="info-icon" id="assessmentIcon">ğŸ‘¶</span>
                                    <div class="info-text">
                                        <div class="info-title" id="assessmentTitle"></div>
                                        <div class="info-desc" id="assessmentDesc"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <label class="modal-label">Child Name</label>
                            <input type="text" class="modal-input" id="childName" placeholder="Enter child's name">
                            
                            <label class="modal-label">Child Age (months)</label>
                            <input type="number" class="modal-input" id="childAge" placeholder="e.g., 24" min="0" max="84">
                            
                            <button class="modal-btn primary" onclick="startEvaluation()">
                                <i class="fas fa-play"></i> Start Evaluation
                            </button>
                        </div>
                        
                        <button class="modal-close-btn" onclick="hideEvaluationModal()">Ã—</button>
                        <div class="modal-pointer"></div>
                    </div>
                </div>

                <!-- Assessment Screen (è©•ä¼°é€²è¡Œä¸­) -->
                <div id="assessmentScreen" style="display: none;">
                    <div class="assessment-screen">
                        <div class="assessment-header">
                            <h2 id="assessmentTitle">è©•ä¼°é€²è¡Œä¸­</h2>
                            <p id="assessmentInfo">è«‹æ ¹æ“šå½±ç‰‡ç¤ºç¯„ï¼Œè§€å¯Ÿå­©å­æ˜¯å¦èƒ½å®Œæˆå‹•ä½œ</p>
                        </div>
                        
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        
                        <div id="assessmentContent"></div>
                        
                        <div class="control-buttons">
                            <button class="btn-secondary" onclick="backToAssessmentList()">
                                â† è¿”å›è©•ä¼°åˆ—è¡¨
                            </button>
                            <button class="btn-primary-submit" id="submitBtn" style="display: none;" onclick="submitAssessment()">
                                âœ“ æäº¤è©•ä¼°
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Evaluation Modal -->
    <div class="evaluation-modal" id="evaluationModal">
        <div class="modal-content">
            <h2>ğŸ» é–‹å§‹è©•ä¼°</h2>
            
            <form id="evaluationForm" onsubmit="startEvaluation(event)">
                <div class="form-group">
                    <label>è©•ä¼°åç¨±</label>
                    <input type="text" id="assessmentName" placeholder="è¼¸å…¥è©•ä¼°åç¨±" required>
                </div>

                <div class="form-group">
                    <label>å…’ç«¥å§“å</label>
                    <input type="text" id="childName" placeholder="è¼¸å…¥å…’ç«¥å§“å" required>
                </div>

                <div class="form-group">
                    <label>å…’ç«¥å¹´é½¡ï¼ˆæœˆæ•¸ï¼‰</label>
                    <input type="number" id="childAge" placeholder="ä¾‹å¦‚ï¼š24" min="0" max="84" required>
                </div>

                <div class="form-group">
                    <label>é¸æ“‡å½±ç‰‡æª”æ¡ˆæˆ–è²¼ä¸Š YouTube é€£çµ</label>
                    <div class="file-input-group" onclick="document.getElementById('videoInput').click()">
                        <i class="fas fa-video"></i>
                        <p>é¸æ“‡å½±ç‰‡æª”æ¡ˆ</p>
                        <small>æˆ–</small>
                    </div>
                    <input type="file" id="videoInput" accept="video/*" class="hidden" onchange="handleVideoSelect(event)">
                    <div id="videoFileName" class="file-name-display"></div>
                    <input type="url" class="youtube-input" id="youtubeUrl" placeholder="è²¼ä¸Š YouTube é€£çµ">
                </div>

                <button type="submit" class="btn-start">
                    é–‹å§‹
                </button>
            </form>
        </div>
    </div>

    <!-- Settings Modal (included from separate file) -->
    {% include 'setting.html' %}
    
    <!-- Auth check script -->
    <script>
        if (!localStorage.getItem('access_token')) {
            window.location.href = '/login';
        }

        // Handle logout
        document.getElementById('logout').addEventListener('click', async () => {
            localStorage.removeItem('access_token');
            window.location.href = '/login';
        });

        // Handle child assessment navigation
        document.getElementById('childAssessment').addEventListener('click', () => {
            showAssessmentView();
        });

        // Assessment Functions
        function showAssessmentView() {
            const chatContainer = document.getElementById('chat-container');
            const assessmentContainer = document.getElementById('assessment-container');
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('main-content');
            
            // Hide chat and sidebar
            chatContainer.style.display = 'none';
            sidebar.style.display = 'none';
            sidebar.classList.add('hidden');
            
            // Show assessment (full screen)
            assessmentContainer.style.display = 'flex';
            mainContent.style.marginLeft = '0';
        }

        function returnToChat() {
            console.log('returnToChat() called');
            const assessmentContainer = document.getElementById('assessment-container');
            const chatContainer = document.getElementById('chat-container');
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('main-content');
            
            // Hide assessment
            assessmentContainer.style.display = 'none';
            
            // Show chat and sidebar
            chatContainer.style.display = 'flex';
            chatContainer.style.visibility = 'visible';
            chatContainer.style.opacity = '1';
            
            sidebar.style.display = 'flex';
            sidebar.style.visibility = 'visible';
            sidebar.classList.remove('hidden');
            
            // Reset main content margin (sidebar width is 280px)
            mainContent.style.marginLeft = '280px';
            mainContent.style.display = 'flex';
            
            // Reset assessment view
            resetAssessmentView();
        }

        function resetAssessmentView() {
            document.getElementById('startScreen').style.display = 'block';
            document.getElementById('assessmentScreen').style.display = 'none';
        }

        function backToStart() {
            document.getElementById('assessmentScreen').style.display = 'none';
            document.getElementById('startScreen').style.display = 'block';
            if (typeof ChildAssessmentModule !== 'undefined') {
                ChildAssessmentModule.reset();
            }
        }

        function handleUploadPDF() {
            document.getElementById('pdfInput').click();
        }

        document.getElementById('pdfInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('pdfFileName').textContent = 'âœ“ ' + file.name;
            }
        });

        document.getElementById('videoFileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                alert('å·²é¸æ“‡å½±ç‰‡: ' + file.name);
                showAssessmentList();
            }
        });

        function openEvaluationModal(assessmentId) {
            const modal = document.getElementById('evaluationModal');
            modal.dataset.assessmentId = assessmentId || 'general';
            modal.classList.add('active');
        }

        function handleVideoSelect(event) {
            const file = event.target.files[0];
            if (file) {
                document.getElementById('videoFileName').textContent = 'âœ“ ' + file.name;
                document.getElementById('youtubeUrl').value = '';
            }
        }

        function startEvaluation(event) {
            event.preventDefault();
            
            const assessmentName = document.getElementById('assessmentName').value;
            const childName = document.getElementById('childName').value;
            const childAge = document.getElementById('childAge').value;
            const modal = document.getElementById('evaluationModal');
            const assessmentId = modal.dataset.assessmentId || 'general';

            // éš±è—è©•ä¼°åˆ—è¡¨ï¼Œé¡¯ç¤ºè©•ä¼°ç•«é¢
            document.getElementById('assessmentListScreen').style.display = 'none';
            document.getElementById('assessmentScreen').style.display = 'block';

            // ä½¿ç”¨è©•ä¼°æ¨¡å¡Šé–‹å§‹è©•ä¼°
            if (typeof ChildAssessmentModule !== 'undefined') {
                ChildAssessmentModule.startNewAssessment(childName, childAge, null, assessmentId);
            }

            // é—œé–‰å½ˆçª—ä¸¦é‡ç½®è¡¨å–®
            modal.classList.remove('active');
            event.target.reset();
            document.getElementById('videoFileName').textContent = '';
        }

        function submitAssessment() {
            if (typeof ChildAssessmentModule !== 'undefined') {
                ChildAssessmentModule.submitAssessment();
            }
        }

        // Close modal when clicking outside
        document.getElementById('evaluationModal').addEventListener('click', function(event) {
            if (event.target === this) {
                this.classList.remove('active');
            }
        });
    </script>
    
    <!-- å…ˆè¼‰å…¥ API æ¨¡å¡Š -->
    <script src="../static/js/api_module.js"></script>
    <!-- è¼‰å…¥å´é‚Šæ¬„åŠŸèƒ½ (åœ¨ chatbox ä¹‹å‰ï¼Œå› ç‚º chatbox æœƒå‘¼å« sidebar å‡½æ•¸) -->
    <script src="../static/js/sidebar.js"></script>
    <!-- ç„¶å¾Œè¼‰å…¥ä¸»è¦è…³æœ¬ -->
    <script src="../static/js/chatbox.js"></script>
    <!-- è¼‰å…¥è¦–é »ç®¡ç†æ¨¡å¡Š -->
    <script src="../static/js/video_management.js"></script>
    <!-- æœ€å¾Œè¼‰å…¥è¨­å®šåŠŸèƒ½ -->
    <script src="../static/js/settings.js"></script>
    <!-- è¼‰å…¥è©•ä¼°é…ç½® -->
    <script src="../static/js/assessment_config.js"></script>
    <!-- è¼‰å…¥è©•ä¼°é¡Œåº« -->
    <script src="../static/js/assessment_questions.js"></script>
    <!-- è¼‰å…¥å…’ç«¥è©•ä¼°æ¨¡å¡Š -->
    <script src="../static/js/child_assessment.js"></script>
    
    <script>
        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–è©•ä¼°é¸é …
        document.addEventListener('DOMContentLoaded', function() {
            loadAssessmentOptions();
        });
        
        // è¼‰å…¥è©•ä¼°é¸é …
        function loadAssessmentOptions() {
            const selectElement = document.getElementById('assessmentType');
            const categories = AssessmentConfig.getEnabledCategories();
            
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = `${cat.icon} ${cat.nameEn}`;
                option.dataset.icon = cat.icon;
                option.dataset.name = cat.nameEn;
                option.dataset.desc = cat.descriptionEn;
                selectElement.appendChild(option);
            });
        }
        
        // æ›´æ–°è©•ä¼°è³‡è¨Šé¡¯ç¤º
        function updateAssessmentInfo() {
            const selectElement = document.getElementById('assessmentType');
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const infoBox = document.getElementById('assessmentInfoBox');
            
            if (selectElement.value) {
                const category = AssessmentConfig.getCategoryById(selectElement.value);
                document.getElementById('assessmentIcon').textContent = category.icon;
                document.getElementById('assessmentTitle').textContent = category.nameEn;
                document.getElementById('assessmentDesc').textContent = category.descriptionEn + ' (' + category.ageRange + ')';
                infoBox.style.display = 'block';
            } else {
                infoBox.style.display = 'none';
            }
        }
        
        // è™•ç†è¦–é »æ–‡ä»¶é¸æ“‡
        function handleVideoFileSelect(input) {
            const file = input.files[0];
            const display = document.getElementById('videoFileName');
            if (file) {
                display.textContent = 'âœ“ ' + file.name;
                display.classList.add('active');
            }
        }
        
        // åˆ‡æ›YouTubeè¼¸å…¥æ¡†
        function toggleYoutubeInput() {
            const input = document.getElementById('youtubeUrlInput');
            if (input.style.display === 'none') {
                input.style.display = 'block';
                input.focus();
            } else {
                input.style.display = 'none';
            }
        }
        
        // æ–°è¨­è¨ˆçš„å½ˆçª—æ§åˆ¶
        function showEvaluationModal() {
            document.getElementById('evaluationModal').style.display = 'block';
        }
        
        function hideEvaluationModal() {
            document.getElementById('evaluationModal').style.display = 'none';
            // é‡ç½®è¡¨å–®
            document.getElementById('assessmentType').value = '';
            document.getElementById('childName').value = '';
            document.getElementById('childAge').value = '';
            document.getElementById('assessmentInfoBox').style.display = 'none';
        }
        
        function startEvaluation() {
            const assessmentType = document.getElementById('assessmentType').value;
            const childName = document.getElementById('childName').value;
            const childAge = document.getElementById('childAge').value;
            
            if (!assessmentType) {
                alert('Please select an assessment type');
                return;
            }
            
            if (!childName) {
                alert('Please enter child\'s name');
                return;
            }
            
            if (!childAge) {
                alert('Please enter child\'s age');
                return;
            }
            
            // å„²å­˜è©•ä¼°è³‡è¨Š
            const assessmentData = {
                type: assessmentType,
                childName: childName,
                childAge: parseInt(childAge),
                category: AssessmentConfig.getCategoryById(assessmentType),
                startTime: new Date().toISOString()
            };
            
            console.log('Starting evaluation with:', assessmentData);
            
            // éš±è—å½ˆçª—
            hideEvaluationModal();
            
            // ç›´æ¥é–‹å§‹è©•ä¼°ï¼ˆä½¿ç”¨æ­£ç¢ºçš„æ–¹æ³•ï¼‰
            if (typeof ChildAssessmentModule !== 'undefined') {
                ChildAssessmentModule.startNewAssessment(childName, childAge, null, assessmentType);
            } else {
                console.error('ChildAssessmentModule not loaded');
                alert('Assessment module not loaded. Please refresh the page.');
            }
        }
    </script>
</body>
</html>