<!DOCTYPE html>
<html lang="zh-tw" data-i18n-pending="true">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="index.pageTitle">èŠå¤©ç›’å­</title>
    <!-- Anti-FOUC: inline critical background -->
    <style>
        html, body { margin: 0; padding: 0; }
        body { background: linear-gradient(135deg, #D4C5E8 0%, #C8B8DB 50%, #B8A8D8 100%); min-height: 100vh; }
        body.dark-theme, html.dark-theme-early body { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #1a1a2e 100%); color: #E2D7F5; }
    </style>
    <script>
        try {
            const preferredLang = localStorage.getItem('preferredLanguage') || 'zh-TW';
            document.documentElement.setAttribute('lang', preferredLang.toLowerCase());
            // Early dark-theme detection to prevent background flash
            var _t = localStorage.getItem('themeMode');
            if (_t === 'dark' || (_t === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark-theme-early');
            }
        } catch (e) {
            // no-op
        }
    </script>
    <!-- Assessment styles -->
    <link rel="stylesheet" href="../static/css/index.css">
    <link rel="stylesheet" href="../static/css/settings.css?v=2">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Prefetch resources for other pages to speed up navigation -->
    <link rel="prefetch" href="../static/css/pose_detection.css" as="style">
    <link rel="prefetch" href="../static/css/sidebar.css" as="style">
    <link rel="prefetch" href="../static/css/chatbox.css" as="style">
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://cdn.socket.io">
</head>
<body>
    <header class="child-backbar" id="childBackBar" style="display: none;">
        <button class="btn btn-secondary" onclick="backToAssessmentList()">
            <i class="fas fa-arrow-left"></i>
            <span data-i18n="index.back">è¿”å›</span>
        </button>
    </header>
    <div id="messages" aria-live="polite"></div>
    
    <!-- Assessment Container (é»˜èªé¡¯ç¤º) -->
    <div id="assessment-container" style="display: flex;">
        <!-- ä¸»å…§å®¹å€åŸŸ -->
        <div class="assessment-content-area" style="width: 100%;">
            <!-- è²“é ­é·¹è£é£¾ -->
            <div class="owl-decoration">ğŸ¦‰</div>
            
            <!-- Assessment Main -->
            <div class="assessment-main" id="assessmentMain">
                <!-- Start Screen -->
                <div id="startScreen">
                    <div class="new-start-card">
                        <h1 class="new-card-title" data-i18n="index.startNewAssessment">é–‹å§‹æ–°çš„è©•ä¼°</h1>
                        
                        <div class="new-upload-options">
                            <!-- Start Assessment (was Upload PDF) -->
                            <div class="new-upload-item" onclick="showEvaluationModal()">
                                <div class="new-upload-icon">
                                    <i class="fas fa-clipboard-list"></i>
                                </div>
                                <div class="new-upload-label" data-i18n="index.startAssessment">é–‹å§‹è©•ä¼°</div>
                            </div>

                            <!-- Upload Video -->
                            <div class="new-upload-item" onclick="window.location.href='/video'">
                                <div class="new-upload-icon">
                                    <i class="fas fa-video"></i>
                                </div>
                                <div class="new-upload-label">
                                    <span data-i18n="index.uploadVideo">ä¸Šå‚³å½±ç‰‡</span><br>
                                    <small data-i18n="index.uploadVideoHint">ï¼ˆç”¨æ–¼å‹•ä½œè©•ä¼°ï¼‰</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- åº•éƒ¨æŒ‰éˆ• -->
                        <div class="bottom-buttons">
                            <button class="bottom-btn primary" onclick="window.location.href='/pose_detection'">
                                <i class="fas fa-running"></i> <span data-i18n="index.poseAssessment">å§¿å‹¢æª¢æ¸¬è©•ä¼°</span>
                            </button>
                            <button class="bottom-btn primary" onclick="window.location.href='/chatbox'">
                                <i class="fas fa-comments"></i> <span data-i18n="index.enterChat">é€²å…¥èŠå¤©å®¤</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Begin Evaluation Modal -->
                <div id="evaluationModal" class="evaluation-modal">
                    <div class="modal-content-evaluation">
                        <h2 class="modal-title" data-i18n="index.modal.title">é–‹å§‹è©•ä¼°</h2>
                        
                        <div class="modal-form">
                            <label class="modal-label" data-i18n="index.modal.typeLabel">é¸æ“‡è©•ä¼°é¡å‹</label>
                            <select class="modal-input" id="assessmentType" onchange="updateAssessmentInfo()">
                                <option value="" data-i18n="index.modal.typePlaceholder">é¸æ“‡è©•ä¼°â€¦</option>
                            </select>
                            
                            <div id="assessmentInfoBox" class="assessment-info-box" style="display: none;">
                                <div class="info-row">
                                    <span class="info-icon" id="assessmentIcon">ğŸ‘¶</span>
                                    <div class="info-text">
                                        <div class="info-title" id="assessmentTitle"></div>
                                        <div class="info-desc" id="assessmentDesc"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <label class="modal-label" data-i18n="index.modal.childNameLabel">å…’ç«¥å§“å</label>
                            <input type="text" class="modal-input" id="childName" placeholder="è¼¸å…¥å…’ç«¥å§“å" data-i18n-placeholder="index.modal.childNamePlaceholder">
                            
                            <label class="modal-label" data-i18n="index.modal.childAgeLabel">å…’ç«¥å¹´é½¡ï¼ˆæœˆæ•¸ï¼‰</label>
                            <input type="number" class="modal-input" id="childAge" placeholder="ä¾‹å¦‚ï¼š24" min="0" max="84" data-i18n-placeholder="index.modal.childAgePlaceholder">
                            
                            <button class="modal-btn primary" onclick="startEvaluation()">
                                <i class="fas fa-play"></i> <span data-i18n="index.modal.startButton">é–‹å§‹è©•ä¼°</span>
                            </button>
                        </div>
                        
                        <button class="modal-close-btn" onclick="hideEvaluationModal()">Ã—</button>
                        <div class="modal-pointer"></div>
                    </div>
                </div>

                <!-- Assessment Screen (è©•ä¼°é€²è¡Œä¸­) -->
                <div id="assessmentScreen" style="display: none;">
                    <div class="assessment-screen">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        
                        <div id="assessmentContent"></div>
                        
                        <div class="control-buttons">
                            <button class="btn-primary-submit" id="submitBtn" style="display: none;" onclick="submitAssessment()">
                                <span data-i18n="index.assessment.submit">âœ“ æäº¤è©•ä¼°</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="floating-actions" aria-label="å¿«é€Ÿæ“ä½œ">
        <button id="settings" class="floating-btn" type="button" title="è¨­å®š">
            <i class="fas fa-gear"></i>
            <span data-i18n="settings">è¨­å®š</span>
        </button>
        <button id="logout" class="floating-btn danger" type="button" title="ç™»å‡º">
            <i class="fas fa-right-from-bracket"></i>
            <span data-i18n="logout">ç™»å‡º</span>
        </button>
    </div>

    <!-- Evaluation Modal -->
    <div class="evaluation-modal" id="evaluationModal">
        <div class="modal-content">
            <h2><span data-i18n="index.modal2.title">ğŸ» é–‹å§‹è©•ä¼°</span></h2>
            
            <form id="evaluationForm" onsubmit="startEvaluation(event)">
                <div class="form-group">
                    <label data-i18n="index.modal2.assessmentNameLabel">è©•ä¼°åç¨±</label>
                    <input type="text" id="assessmentName" placeholder="è¼¸å…¥è©•ä¼°åç¨±" required data-i18n-placeholder="index.modal2.assessmentNamePlaceholder">
                </div>

                <div class="form-group">
                    <label data-i18n="index.modal2.childNameLabel">å…’ç«¥å§“å</label>
                    <input type="text" id="childName" placeholder="è¼¸å…¥å…’ç«¥å§“å" required data-i18n-placeholder="index.modal2.childNamePlaceholder">
                </div>

                <div class="form-group">
                    <label data-i18n="index.modal2.childAgeLabel">å…’ç«¥å¹´é½¡ï¼ˆæœˆæ•¸ï¼‰</label>
                    <input type="number" id="childAge" placeholder="ä¾‹å¦‚ï¼š24" min="0" max="84" required data-i18n-placeholder="index.modal2.childAgePlaceholder">
                </div>

                <div class="form-group">
                    <label data-i18n="index.modal2.videoLabel">é¸æ“‡å½±ç‰‡æª”æ¡ˆæˆ–è²¼ä¸Š YouTube é€£çµ</label>
                    <div class="file-input-group" onclick="document.getElementById('videoInput').click()">
                        <i class="fas fa-video"></i>
                        <p data-i18n="index.modal2.videoSelect">é¸æ“‡å½±ç‰‡æª”æ¡ˆ</p>
                        <small data-i18n="index.modal2.or">æˆ–</small>
                    </div>
                        <input type="file" id="videoInput" accept="video/*" class="hidden" onchange="handleVideoSelect(event)">
                    <div id="videoFileName" class="file-name-display"></div>
                    <input type="url" class="youtube-input" id="youtubeUrl" placeholder="è²¼ä¸Š YouTube é€£çµ" data-i18n-placeholder="index.modal2.youtubePlaceholder">
                </div>

                <button type="submit" class="btn-start">
                    <span data-i18n="index.modal2.startButton">é–‹å§‹</span>
                </button>
            </form>
        </div>
    </div>

    <!-- Settings Modal (included from separate file) -->
    {% include 'setting.html' %}

    <!-- Child Assessment Templates -->
    {% include 'child_assessment_templates.html' %}

    <script src="../static/js/settings.js"></script>
    
    <!-- Auth check script -->
    <script>
        if (!localStorage.getItem('access_token')) {
            window.location.href = '/login';
        }

        // Handle logout (guarded because sidebar was removed)
        const logoutBtn = document.getElementById('logout');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', async () => {
                localStorage.removeItem('access_token');
                window.location.href = '/login';
            });
        }

        // Handle child assessment navigation (guarded)
        const childAssessmentBtn = document.getElementById('childAssessment');
        if (childAssessmentBtn) {
            childAssessmentBtn.addEventListener('click', () => {
                showAssessmentView();
            });
        }

        // Assessment Functions
        function showAssessmentView() {
            const chatContainer = document.getElementById('chat-container');
            const assessmentContainer = document.getElementById('assessment-container');
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('main-content');
            
            // Hide chat (sidebar is removed; guard if exists)
            chatContainer.style.display = 'none';
            if (sidebar) {
                sidebar.style.display = 'none';
                sidebar.classList.add('hidden');
            }
            
            // Show assessment (full screen)
            assessmentContainer.style.display = 'flex';
            mainContent.style.marginLeft = '0';
        }

        function returnToChat() {
            console.log('è¿”å›èŠå¤©è¦–åœ–');
            const assessmentContainer = document.getElementById('assessment-container');
            const chatContainer = document.getElementById('chat-container');
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('main-content');
            
            // Hide assessment
            assessmentContainer.style.display = 'none';
            
            // Show chat (sidebar removed; only restore chat)
            chatContainer.style.display = 'flex';
            chatContainer.style.visibility = 'visible';
            chatContainer.style.opacity = '1';
            if (sidebar) {
                sidebar.style.display = 'flex';
                sidebar.style.visibility = 'visible';
                sidebar.classList.remove('hidden');
            }
            
            // Reset main content margin (sidebar width is 280px)
            mainContent.style.marginLeft = '280px';
            mainContent.style.display = 'flex';
            
            // Reset assessment view
            resetAssessmentView();
        }

        function resetAssessmentView() {
            document.getElementById('startScreen').style.display = 'block';
            document.getElementById('assessmentScreen').style.display = 'none';
        }

        function backToStart() {
            document.getElementById('assessmentScreen').style.display = 'none';
            document.getElementById('startScreen').style.display = 'block';
            if (typeof ChildAssessmentModule !== 'undefined') {
                ChildAssessmentModule.reset();
            }
        }

    // PDF upload removed: UI no longer uses pdf input from this page.

        function openEvaluationModal(assessmentId) {
            const modal = document.getElementById('evaluationModal');
            modal.dataset.assessmentId = assessmentId || 'general';
            modal.classList.add('active');
        }

        function handleVideoSelect(event) {
            const file = event.target.files[0];
            if (file) {
                document.getElementById('videoFileName').textContent = 'âœ“ ' + file.name;
                document.getElementById('youtubeUrl').value = '';
            }
        }

        function startEvaluation(event) {
            event.preventDefault();
            
            const assessmentName = document.getElementById('assessmentName').value;
            const childName = document.getElementById('childName').value;
            const childAge = document.getElementById('childAge').value;
            const modal = document.getElementById('evaluationModal');
            const assessmentId = modal.dataset.assessmentId || 'general';

            // éš±è—é–‹å§‹ç•«é¢ï¼Œé¡¯ç¤ºè©•ä¼°ç•«é¢
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('assessmentScreen').style.display = 'block';
            const backBar = document.getElementById('childBackBar');
            if (backBar) {
                backBar.style.display = 'flex';
            }

            // ä½¿ç”¨è©•ä¼°æ¨¡å¡Šé–‹å§‹è©•ä¼°
            if (typeof ChildAssessmentModule !== 'undefined') {
                ChildAssessmentModule.startNewAssessment(childName, childAge, null, assessmentId);
            }

            // é—œé–‰å½ˆçª—ä¸¦é‡ç½®è¡¨å–®
            modal.classList.remove('active');
            try {
                event.target.reset();
            } catch (e) {
                // event å¯èƒ½ä¸æ˜¯ä¾†è‡ªè¡¨å–®æäº¤ï¼Œå¿½ç•¥
            }
            const vf = document.getElementById('videoFileName');
            if (vf) vf.textContent = '';
        }

        function submitAssessment() {
            if (typeof ChildAssessmentModule !== 'undefined') {
                ChildAssessmentModule.submitAssessment();
            }
        }

        function backToAssessmentList() {
            // éš±è—è©•ä¼°ç•«é¢ï¼Œé¡¯ç¤ºé–‹å§‹ç•«é¢
            document.getElementById('assessmentScreen').style.display = 'none';
            document.getElementById('startScreen').style.display = 'block';
            const backBar = document.getElementById('childBackBar');
            if (backBar) {
                backBar.style.display = 'none';
            }
            
            // é‡ç½®è©•ä¼°æ•¸æ“š
            if (typeof ChildAssessmentModule !== 'undefined') {
                ChildAssessmentModule.assessmentData = null;
                ChildAssessmentModule.currentQuestionIndex = 0;
                ChildAssessmentModule.assessmentAnswers = {};
            }
        }

        // Close modal when clicking outside
        document.getElementById('evaluationModal').addEventListener('click', function(event) {
            if (event.target === this) {
                this.classList.remove('active');
            }
        });
    </script>
    
    <!-- è¼‰å…¥è¦–é »ç®¡ç†æ¨¡å¡Š -->
    <script src="../static/js/video_access.js"></script>
    <!-- è¼‰å…¥è©•ä¼°é…ç½® -->
    <script src="../static/js/assessment_config.js"></script>
    <!-- è¼‰å…¥è©•ä¼°é¡Œåº« -->
    <script src="../static/js/assessment_questions.js"></script>
    <!-- html2canvas ç”¨æ–¼ç”ŸæˆPDFå ±å‘Š -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- jsPDF åº«ç”¨æ–¼ç”ŸæˆPDFå ±å‘Š -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="../static/js/child_assessment.js"></script>
    
    <script>
        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–è©•ä¼°é¸é …
        document.addEventListener('DOMContentLoaded', function() {
            loadAssessmentOptions();
        });
        
        // è¼‰å…¥è©•ä¼°é¸é …
        function loadAssessmentOptions() {
            const selectElement = document.getElementById('assessmentType');
            const categories = AssessmentConfig.getEnabledCategories();
            
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = `${cat.icon} ${cat.nameEn}`;
                option.dataset.icon = cat.icon;
                option.dataset.name = cat.nameEn;
                option.dataset.desc = cat.descriptionEn;
                selectElement.appendChild(option);
            });
        }
        
        // æ›´æ–°è©•ä¼°è³‡è¨Šé¡¯ç¤º
        function updateAssessmentInfo() {
            const selectElement = document.getElementById('assessmentType');
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const infoBox = document.getElementById('assessmentInfoBox');
            
            if (selectElement.value) {
                const category = AssessmentConfig.getCategoryById(selectElement.value);
                document.getElementById('assessmentIcon').textContent = category.icon;
                document.getElementById('assessmentTitle').textContent = category.nameEn;
                document.getElementById('assessmentDesc').textContent = category.descriptionEn + ' (' + category.ageRange + ')';
                infoBox.style.display = 'block';
            } else {
                infoBox.style.display = 'none';
            }
        }
        
        // è™•ç†è¦–é »æ–‡ä»¶é¸æ“‡
        function handleVideoFileSelect(input) {
            const file = input.files[0];
            const display = document.getElementById('videoFileName');
            if (file) {
                display.textContent = 'âœ“ ' + file.name;
                display.classList.add('active');
            }
        }
        
        // åˆ‡æ›YouTubeè¼¸å…¥æ¡†
        function toggleYoutubeInput() {
            const input = document.getElementById('youtubeUrlInput');
            if (input.style.display === 'none') {
                input.style.display = 'block';
                input.focus();
            } else {
                input.style.display = 'none';
            }
        }
        
        // æ–°è¨­è¨ˆçš„å½ˆçª—æ§åˆ¶
        function showEvaluationModal() {
            document.getElementById('evaluationModal').classList.add('active');
        }
        
        function hideEvaluationModal() {
            document.getElementById('evaluationModal').classList.remove('active');
            // é‡ç½®è¡¨å–®
            document.getElementById('assessmentType').value = '';
            document.getElementById('childName').value = '';
            document.getElementById('childAge').value = '';
            document.getElementById('assessmentInfoBox').style.display = 'none';
        }
        
        function startEvaluation() {
            const assessmentType = document.getElementById('assessmentType').value;
            const childName = document.getElementById('childName').value;
            const childAge = document.getElementById('childAge').value;
            
            if (!assessmentType) {
                alert('è«‹é¸æ“‡è©•ä¼°é¡å‹');
                return;
            }
            
            if (!childName) {
                alert('è«‹è¼¸å…¥å…’ç«¥å§“å');
                return;
            }
            
            if (!childAge) {
                alert('è«‹è¼¸å…¥å…’ç«¥å¹´é½¡');
                return;
            }
            
            // å„²å­˜è©•ä¼°è³‡è¨Š
            const assessmentData = {
                type: assessmentType,
                childName: childName,
                childAge: parseInt(childAge),
                category: AssessmentConfig.getCategoryById(assessmentType),
                startTime: new Date().toISOString()
            };
            
            console.log('é–‹å§‹è©•ä¼°ï¼Œåƒæ•¸ï¼š', assessmentData);
            
            // éš±è—å½ˆçª—
            hideEvaluationModal();
            
            // ç›´æ¥é–‹å§‹è©•ä¼°ï¼ˆä½¿ç”¨æ­£ç¢ºçš„æ–¹æ³•ï¼‰
            if (typeof ChildAssessmentModule !== 'undefined') {
                ChildAssessmentModule.startNewAssessment(childName, childAge, null, assessmentType);
            } else {
                console.error('ChildAssessmentModule æœªè¼‰å…¥');
                alert('è©•ä¼°æ¨¡çµ„æœªè¼‰å…¥ã€‚è«‹é‡æ–°æ•´ç†é é¢ã€‚');
            }
        }
    </script>
</body>
</html>