<!DOCTYPE html>
<html lang="zh-tw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å¾Œå° - XIAOICE</title>
    <link rel="stylesheet" href="/static/css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html, body { margin: 0; padding: 0; }
        body { background: linear-gradient(135deg, #D4C5E8 0%, #C8B8DB 50%, #B8A8D8 100%); min-height: 100vh; }
        body.dark-theme, html.dark-theme-early body { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #1a1a2e 100%); color: #E2D7F5; }
    </style>
</head>
<body class="admin-page">

    <!-- Floating Decorations -->
    <div class="floating-stars">
        <span class="star">âœ¦</span>
        <span class="star">âœ§</span>
        <span class="star">âœ¦</span>
        <span class="star">âœ§</span>
        <span class="star">âœ¦</span>
    </div>

    <div class="cloud cloud-1"></div>
    <div class="cloud cloud-2"></div>
    <div class="cloud cloud-3"></div>

    <!-- Header -->
    <header class="admin-header">
        <div class="header-left">
            <button class="back-btn" onclick="window.location.href='/'">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h1 class="admin-title">
                <i class="fas fa-shield-halved"></i>
                ç®¡ç†å¾Œå°
            </h1>
        </div>
        <div class="header-right">
            <div class="admin-avatar">
                <i class="fas fa-user-crown"></i>
            </div>
            <span class="admin-label">ç®¡ç†å“¡</span>
        </div>
    </header>

    <!-- Main Container -->
    <div class="admin-container">
        
        <!-- Navigation Cards -->
        <nav class="admin-nav">
            <div class="nav-card active" data-section="overview">
                <div class="nav-icon-wrap">
                    <i class="fas fa-chart-pie"></i>
                </div>
                <span>ç¸½è¦½</span>
            </div>
            <div class="nav-card" data-section="users">
                <div class="nav-icon-wrap">
                    <i class="fas fa-users"></i>
                </div>
                <span>ç”¨æˆ¶ç®¡ç†</span>
            </div>            
            <div class="nav-card" data-section="knowledge-base">
                <div class="nav-icon-wrap">
                    <i class="fas fa-brain"></i>
                </div>
                <span>çŸ¥è­˜åº«</span>
            </div>
        </nav>

        <!-- Content Area -->
        <main class="admin-content">
            
            <!-- Overview Section -->
            <section id="section-overview" class="content-section active">
                <div class="welcome-banner">
                    <div class="mascot">ğŸ¦‰</div>
                    <div class="welcome-text">
                        <h2>æ­¡è¿å›ä¾†ï¼Œç®¡ç†å“¡ï¼</h2>
                        <p>é€™è£¡æ˜¯ç³»çµ±ç¸½è¦½ï¼Œä½ å¯ä»¥æŸ¥çœ‹æ‰€æœ‰é‹è¡Œç‹€æ…‹</p>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card purple">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info">
                            <span class="stat-number">1,250</span>
                            <span class="stat-label">ç¸½ç”¨æˆ¶æ•¸</span>
                        </div>
                        <div class="stat-badge new">+15 ä»Šæ—¥</div>
                    </div>
                    <div class="stat-card blue">
                        <div class="stat-icon">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <div class="stat-info">
                            <span class="stat-number">45</span>
                            <span class="stat-label">æ´»èºèª²ç¨‹</span>
                        </div>
                        <div class="stat-badge">æ­£å¸¸</div>
                    </div>
                    <div class="stat-card orange">
                        <div class="stat-icon">
                            <i class="fas fa-exclamation-circle"></i>
                        </div>
                        <div class="stat-info">
                            <span class="stat-number">12</span>
                            <span class="stat-label">å¾…è™•ç†äº‹é …</span>
                        </div>
                        <div class="stat-badge warning">éœ€é—œæ³¨</div>
                    </div>
                    <div class="stat-card green">
                        <div class="stat-icon">
                            <i class="fas fa-server"></i>
                        </div>
                        <div class="stat-info">
                            <span class="stat-number">99.9%</span>
                            <span class="stat-label">ç³»çµ±å¯ç”¨æ€§</span>
                        </div>
                        <div class="stat-badge success">è‰¯å¥½</div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="quick-actions">
                    <h3><i class="fas fa-bolt"></i> å¿«é€Ÿæ“ä½œ</h3>
                    <div class="action-grid">
                        <button class="action-card" id="btnAddUser">
                            <i class="fas fa-user-plus"></i>
                            <span>æ–°å¢ç”¨æˆ¶</span>
                        </button>
                        <button class="action-card">
                            <i class="fas fa-file-upload"></i>
                            <span>ä¸Šå‚³æ•™æ</span>
                        </button>
                        <button class="action-card">
                            <i class="fas fa-bullhorn"></i>
                            <span>ç™¼å¸ƒå…¬å‘Š</span>
                        </button>
                        <button class="action-card" onclick="document.querySelector('[data-section=\'knowledge-base\']').click()">
                            <i class="fas fa-search"></i>
                            <span>æ¸¬è©¦æª¢ç´¢</span>
                        </button>
                    </div>
                </div>
            </section>

            <!-- Knowledge Base Section -->
            <section id="section-knowledge-base" class="content-section">
                <div class="section-header">
                    <h2><i class="fas fa-brain"></i> çŸ¥è­˜åº«ç®¡ç†</h2>
                    <p>ç®¡ç† AI å°è©±ç³»çµ±çš„çŸ¥è­˜åº«æ–‡ä»¶</p>
                </div>

                <!-- Upload Area -->
                <div class="kb-upload-area" id="kbUploadArea">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <div class="upload-text">
                        <h3>é»æ“Šæˆ–æ‹–æ”¾æ–‡ä»¶ä¸Šå‚³</h3>
                        <p>æ”¯æ´æ ¼å¼ï¼šPDFã€TXTã€Markdownï¼ˆå¯æ‰¹é‡ä¸Šå‚³ï¼‰</p>
                    </div>
                    <input type="file" id="kbFileInput" accept=".pdf,.txt,.md" multiple style="display:none;">
                </div>

                <!-- Document List -->
                <div class="kb-section">
                    <h3><i class="fas fa-folder-open"></i> å·²ä¸Šå‚³æ–‡ä»¶</h3>
                    <table class="kb-table" id="kbDocTable">
                        <thead>
                            <tr>
                                <th>æ–‡ä»¶åç¨±</th>
                                <th>æ ¼å¼</th>
                                <th>å¤§å°</th>
                                <th>åˆ†æ®µæ•¸</th>
                                <th>ç‹€æ…‹</th>
                                <th>ä¸Šå‚³æ—¥æœŸ</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="kbDocBody">
                            <tr><td colspan="7" class="kb-empty">è¼‰å…¥ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Search Test -->
                <div class="kb-section">
                    <h3><i class="fas fa-search"></i> æª¢ç´¢æ¸¬è©¦</h3>
                    <div class="kb-search-bar">
                        <input type="text" id="kbSearchInput" placeholder="è¼¸å…¥æŸ¥è©¢ä»¥æ¸¬è©¦çŸ¥è­˜åº«æª¢ç´¢æ•ˆæœ...">
                        <button id="kbSearchBtn">
                            <i class="fas fa-search"></i> æœå°‹
                        </button>
                    </div>
                    <div class="kb-results" id="kbSearchResults">
                        <div class="kb-empty">è¼¸å…¥æŸ¥è©¢å¾Œé»æ“Šæœå°‹</div>
                    </div>
                </div>
            </section>

            <!-- Users Section -->
            <section id="section-users" class="content-section">
                <div class="section-header">
                    <h2><i class="fas fa-users"></i> ç”¨æˆ¶ç®¡ç†</h2>
                    <p>ç®¡ç†ç³»çµ±ç”¨æˆ¶å¸³æˆ¶å’Œæ¬Šé™</p>
                </div>

                <div class="users-toolbar">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="æœå°‹ç”¨æˆ¶...">
                    </div>
                    <div class="filter-tabs">
                        <button class="filter-tab active">å…¨éƒ¨</button>
                        <button class="filter-tab">ç®¡ç†å“¡</button>
                        <button class="filter-tab">æ•™å¸«</button>
                        <button class="filter-tab">å­¸ç”Ÿ</button>
                    </div>
                </div>

                <div class="users-table-container">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox"></th>
                                <th>ç”¨æˆ¶å</th>
                                <th>Email</th>
                                <th>è§’è‰²</th>
                                <th>è¨»å†Šæ—¥æœŸ</th>
                                <th>ç‹€æ…‹</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><input type="checkbox"></td>
                                <td>
                                    <div class="user-cell">
                                        <div class="user-avatar">A</div>
                                        <span>Admin User</span>
                                    </div>
                                </td>
                                <td>admin@xiaoice.com</td>
                                <td><span class="role-badge admin">ç®¡ç†å“¡</span></td>
                                <td>2024-01-15</td>
                                <td><span class="status-badge active">æ´»èº</span></td>
                                <td>
                                    <button class="table-btn edit"><i class="fas fa-edit"></i></button>
                                    <button class="table-btn delete"><i class="fas fa-trash"></i></button>
                                </td>
                            </tr>
                            <tr>
                                <td><input type="checkbox"></td>
                                <td>
                                    <div class="user-cell">
                                        <div class="user-avatar teacher">T</div>
                                        <span>Teacher Lee</span>
                                    </div>
                                </td>
                                <td>teacher@xiaoice.com</td>
                                <td><span class="role-badge teacher">æ•™å¸«</span></td>
                                <td>2024-03-20</td>
                                <td><span class="status-badge active">æ´»èº</span></td>
                                <td>
                                    <button class="table-btn edit"><i class="fas fa-edit"></i></button>
                                    <button class="table-btn delete"><i class="fas fa-trash"></i></button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="pagination">
                    <button class="page-btn"><i class="fas fa-chevron-left"></i></button>
                    <span class="page-info">ç¬¬ 1 é ï¼Œå…± 10 é </span>
                    <button class="page-btn"><i class="fas fa-chevron-right"></i></button>
                </div>
            </section>



        </main>
    </div>

    <!-- Modal: Add User -->
    <div class="modal-overlay" id="userModal">
        <div class="modal-box">
            <div class="modal-header">
                <h2><i class="fas fa-user-plus"></i> æ–°å¢ç”¨æˆ¶</h2>
                <button class="modal-close" id="btnCancel">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="role-selector" id="addUserRoleSelector">
                <button class="role-btn active" data-role="user">
                    <i class="fas fa-user-graduate"></i> å­¸ç”Ÿ
                </button>
                <button class="role-btn" data-role="teacher">
                    <i class="fas fa-chalkboard-teacher"></i> æ•™å¸«
                </button>
                <button class="role-btn" data-role="admin">
                    <i class="fas fa-user-shield"></i> ç®¡ç†å“¡
                </button>
            </div>

            <form id="addUserForm">
                <div class="form-group">
                    <label>ç”¨æˆ¶å</label>
                    <input type="text" class="form-input" id="addUsername" placeholder="è¼¸å…¥ç”¨æˆ¶å" required>
                </div>
                <div class="form-group">
                    <label>é›»éƒµåœ°å€</label>
                    <input type="email" class="form-input" id="addEmail" placeholder="example@email.com" required>
                </div>
                <div class="form-group">
                    <label>åˆå§‹å¯†ç¢¼</label>
                    <input type="password" class="form-input" id="addPassword" placeholder="è¼¸å…¥å¯†ç¢¼" required>
                </div>

                <div class="modal-buttons">
                    <button type="button" class="btn-cancel" id="btnCancel2">å–æ¶ˆ</button>
                    <button type="submit" class="btn-create">
                        <i class="fas fa-plus"></i> å‰µå»ºç”¨æˆ¶
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Edit User -->
    <div class="modal-overlay" id="editUserModal">
        <div class="modal-box">
            <div class="modal-header">
                <h2><i class="fas fa-user-edit"></i> ç·¨è¼¯ç”¨æˆ¶</h2>
                <button class="modal-close" id="btnEditCancel">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="editUserForm">
                <input type="hidden" id="editUserId">
                <div class="form-group">
                    <label>ç”¨æˆ¶å</label>
                    <input type="text" class="form-input" id="editUsername" required>
                </div>
                <div class="form-group">
                    <label>é›»éƒµåœ°å€</label>
                    <input type="email" class="form-input" id="editEmail" required>
                </div>
                <div class="form-group">
                    <label>æ–°å¯†ç¢¼ï¼ˆç•™ç©ºä¿æŒåŸå¯†ç¢¼ï¼‰</label>
                    <input type="password" class="form-input" id="editPassword" placeholder="è¼¸å…¥æ–°å¯†ç¢¼">
                </div>
                <div class="form-group">
                    <label>è§’è‰²</label>
                    <select class="form-input" id="editRole">
                        <option value="user">å­¸ç”Ÿ</option>
                        <option value="teacher">æ•™å¸«</option>
                        <option value="admin">ç®¡ç†å“¡</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ç‹€æ…‹</label>
                    <select class="form-input" id="editStatus">
                        <option value="active">å•Ÿç”¨</option>
                        <option value="inactive">åœç”¨</option>
                    </select>
                </div>

                <div class="modal-buttons">
                    <button type="button" class="btn-cancel" id="btnEditCancel2">å–æ¶ˆ</button>
                    <button type="submit" class="btn-create">
                        <i class="fas fa-save"></i> ä¿å­˜æ›´æ”¹
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Auth check - use localStorage since cookie is httponly
        if (!localStorage.getItem('access_token')) {
            window.location.href = '/login';
        }

        // Token getter for API calls
        function getToken() {
            return localStorage.getItem('access_token') || '';
        }

        // User Management State
        let userState = {
            page: 1,
            perPage: 20,
            search: '',
            role: '',
            status: '',
            totalPages: 1
        };

        // Stats State
        let statsData = null;

        document.addEventListener('DOMContentLoaded', () => {
            // ===== Modal: Add User =====
            const modal = document.getElementById('userModal');
            const btnAddUser = document.getElementById('btnAddUser');
            const btnCancel = document.getElementById('btnCancel');
            const btnCancel2 = document.getElementById('btnCancel2');
            const addUserForm = document.getElementById('addUserForm');

            btnAddUser.addEventListener('click', () => {
                modal.classList.add('active');
                resetAddUserForm();
            });
            btnCancel.addEventListener('click', () => modal.classList.remove('active'));
            btnCancel2.addEventListener('click', () => modal.classList.remove('active'));
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.remove('active'); });

            function resetAddUserForm() {
                addUserForm.reset();
                document.querySelectorAll('#addUserRoleSelector .role-btn').forEach(b => b.classList.remove('active'));
                document.querySelector('#addUserRoleSelector .role-btn[data-role="user"]').classList.add('active');
            }

            // Role selector for add user
            document.querySelectorAll('#addUserRoleSelector .role-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('#addUserRoleSelector .role-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });

            addUserForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = document.getElementById('addUsername').value.trim();
                const email = document.getElementById('addEmail').value.trim();
                const password = document.getElementById('addPassword').value;
                const role = document.querySelector('#addUserRoleSelector .role-btn.active').dataset.role;

                try {
                    const res = await fetch('/admin/users', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + getToken(),
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ username, email, password, role })
                    });
                    const data = await res.json();
                    if (res.ok) {
                        alert('ç”¨æˆ¶å‰µå»ºæˆåŠŸï¼');
                        modal.classList.remove('active');
                        loadUsers();
                    } else {
                        alert('éŒ¯èª¤: ' + (data.error || 'å‰µå»ºå¤±æ•—'));
                    }
                } catch (err) {
                    alert('å‰µå»ºå¤±æ•—: ' + err.message);
                }
            });

            // ===== Modal: Edit User =====
            const editModal = document.getElementById('editUserModal');
            const btnEditCancel = document.getElementById('btnEditCancel');
            const btnEditCancel2 = document.getElementById('btnEditCancel2');
            const editUserForm = document.getElementById('editUserForm');

            btnEditCancel.addEventListener('click', () => editModal.classList.remove('active'));
            btnEditCancel2.addEventListener('click', () => editModal.classList.remove('active'));
            editModal.addEventListener('click', (e) => { if (e.target === editModal) editModal.classList.remove('active'); });

            editUserForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const userId = document.getElementById('editUserId').value;
                const username = document.getElementById('editUsername').value.trim();
                const email = document.getElementById('editEmail').value.trim();
                const password = document.getElementById('editPassword').value;
                const role = document.getElementById('editRole').value;
                const isActive = document.getElementById('editStatus').value === 'active';

                const data = { username, email, role, is_active: isActive };
                if (password) data.password = password;

                try {
                    const res = await fetch(`/admin/users/${userId}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': 'Bearer ' + getToken(),
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });
                    const result = await res.json();
                    if (res.ok) {
                        alert('ç”¨æˆ¶æ›´æ–°æˆåŠŸï¼');
                        editModal.classList.remove('active');
                        loadUsers();
                    } else {
                        alert('éŒ¯èª¤: ' + (result.error || 'æ›´æ–°å¤±æ•—'));
                    }
                } catch (err) {
                    alert('æ›´æ–°å¤±æ•—: ' + err.message);
                }
            });

            // ===== Navigation =====
            const navCards = document.querySelectorAll('.nav-card');
            const sections = document.querySelectorAll('.content-section');

            navCards.forEach(card => {
                card.addEventListener('click', function() {
                    navCards.forEach(n => n.classList.remove('active'));
                    this.classList.add('active');

                    const target = this.dataset.section;
                    sections.forEach(s => s.classList.remove('active'));
                    document.getElementById('section-' + target).classList.add('active');

                    if (target === 'overview') loadStats();
                    if (target === 'knowledge-base') loadKbDocuments();
                    if (target === 'users') {
                        loadUsers();
                        loadStats();
                    }
                });
            });

            // Load stats on page load (for overview section)
            loadStats();

            // ===== Theme Toggle =====
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    const theme = this.dataset.theme;
                    if (theme === 'dark') {
                        document.body.classList.add('dark-theme');
                    } else {
                        document.body.classList.remove('dark-theme');
                    }
                });
            });

            // ===== User Management Functions =====
            const usersTableBody = document.querySelector('.users-table tbody');
            const userSearchInput = document.querySelector('.search-box input');
            const filterTabs = document.querySelectorAll('.filter-tab');
            const pageInfo = document.querySelector('.page-info');
            const prevPageBtn = document.querySelector('.pagination .page-btn:first-child');
            const nextPageBtn = document.querySelector('.pagination .page-btn:last-child');

            async function loadStats() {
                try {
                    const res = await fetch('/admin/stats', { headers: { 'Authorization': 'Bearer ' + getToken() } });
                    const data = await res.json();
                    if (res.ok) {
                        statsData = data;
                        updateStatsDisplay();
                    }
                } catch (e) {
                    console.error('Failed to load stats:', e);
                }
            }

            function updateStatsDisplay() {
                if (!statsData) return;
                const statNumbers = document.querySelectorAll('.stat-number');
                if (statNumbers[0]) statNumbers[0].textContent = statsData.users.total.toLocaleString();
                if (statNumbers[1]) statNumbers[1].textContent = statsData.assessments.total || '0';
                if (statNumbers[2]) statNumbers[2].textContent = statsData.videos.total || '0';
                if (statNumbers[3]) statNumbers[3].textContent = statsData.users.new_today || '0';
            }

            async function loadUsers() {
                usersTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">è¼‰å…¥ä¸­...</td></tr>';
                try {
                    const params = new URLSearchParams({
                        page: userState.page,
                        per_page: userState.perPage
                    });
                    if (userState.search) params.append('search', userState.search);
                    if (userState.role) params.append('role', userState.role);
                    if (userState.status) params.append('status', userState.status);

                    const res = await fetch(`/admin/users?${params}`, {
                        headers: { 'Authorization': 'Bearer ' + getToken() }
                    });
                    const data = await res.json();

                    if (!res.ok) {
                        usersTableBody.innerHTML = `<tr><td colspan="7" style="text-align:center;">éŒ¯èª¤: ${data.error || 'è¼‰å…¥å¤±æ•—'}</td></tr>`;
                        return;
                    }

                    userState.totalPages = data.pages;
                    renderUsersTable(data.users);
                    updatePagination();
                } catch (e) {
                    usersTableBody.innerHTML = `<tr><td colspan="7" style="text-align:center;">éŒ¯èª¤: ${e.message}</td></tr>`;
                }
            }

            function renderUsersTable(users) {
                if (!users || users.length === 0) {
                    usersTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">å°šç„¡ç”¨æˆ¶æ•¸æ“š</td></tr>';
                    return;
                }

                usersTableBody.innerHTML = users.map(u => {
                    const roleLabel = { admin: 'ç®¡ç†å“¡', teacher: 'æ•™å¸«', user: 'å­¸ç”Ÿ' }[u.role] || u.role;
                    const roleClass = { admin: 'admin', teacher: 'teacher', user: 'student' }[u.role] || 'student';
                    const statusLabel = u.is_active ? 'æ´»èº' : 'åœç”¨';
                    const statusClass = u.is_active ? 'active' : 'inactive';
                    const createdDate = u.created_at ? new Date(u.created_at).toLocaleDateString('zh-TW') : '-';

                    return `
                        <tr data-user-id="${u.id}">
                            <td><input type="checkbox"></td>
                            <td>
                                <div class="user-cell">
                                    <div class="user-avatar ${roleClass}">${u.username.charAt(0).toUpperCase()}</div>
                                    <span>${u.username}</span>
                                </div>
                            </td>
                            <td>${u.email}</td>
                            <td><span class="role-badge ${roleClass}">${roleLabel}</span></td>
                            <td>${createdDate}</td>
                            <td><span class="status-badge ${statusClass}">${statusLabel}</span></td>
                            <td>
                                <button class="table-btn edit" onclick="openEditUser(${u.id}, '${u.username}', '${u.email}', '${u.role}', ${u.is_active})"><i class="fas fa-edit"></i></button>
                                <button class="table-btn delete" onclick="deleteUser(${u.id})"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            function updatePagination() {
                if (pageInfo) {
                    pageInfo.textContent = `ç¬¬ ${userState.page} é ï¼Œå…± ${userState.totalPages} é `;
                }
                if (prevPageBtn) {
                    prevPageBtn.disabled = userState.page <= 1;
                }
                if (nextPageBtn) {
                    nextPageBtn.disabled = userState.page >= userState.totalPages;
                }
            }

            // User search
            let searchTimeout;
            userSearchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    userState.search = e.target.value.trim();
                    userState.page = 1;
                    loadUsers();
                }, 300);
            });

            // Filter tabs
            filterTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    filterTabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');

                    const filterText = this.textContent.trim();
                    if (filterText === 'å…¨éƒ¨') {
                        userState.role = '';
                    } else if (filterText === 'ç®¡ç†å“¡') {
                        userState.role = 'admin';
                    } else if (filterText === 'æ•™å¸«') {
                        userState.role = 'teacher';
                    } else if (filterText === 'å­¸ç”Ÿ') {
                        userState.role = 'user';
                    }
                    userState.page = 1;
                    loadUsers();
                });
            });

            // Pagination buttons
            if (prevPageBtn) {
                prevPageBtn.addEventListener('click', () => {
                    if (userState.page > 1) {
                        userState.page--;
                        loadUsers();
                    }
                });
            }
            if (nextPageBtn) {
                nextPageBtn.addEventListener('click', () => {
                    if (userState.page < userState.totalPages) {
                        userState.page++;
                        loadUsers();
                    }
                });
            }

            // Global functions for table buttons
            window.openEditUser = function(id, username, email, role, isActive) {
                document.getElementById('editUserId').value = id;
                document.getElementById('editUsername').value = username;
                document.getElementById('editEmail').value = email;
                document.getElementById('editPassword').value = '';
                document.getElementById('editRole').value = role;
                document.getElementById('editStatus').value = isActive ? 'active' : 'inactive';
                editModal.classList.add('active');
            };

            window.deleteUser = async function(id) {
                if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç”¨æˆ¶å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) return;
                try {
                    const res = await fetch(`/admin/users/${id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': 'Bearer ' + getToken() }
                    });
                    const data = await res.json();
                    if (res.ok) {
                        alert('ç”¨æˆ¶å·²åˆªé™¤');
                        loadUsers();
                    } else {
                        alert('éŒ¯èª¤: ' + (data.error || 'åˆªé™¤å¤±æ•—'));
                    }
                } catch (e) {
                    alert('åˆªé™¤å¤±æ•—: ' + e.message);
                }
            };

            // ===== Knowledge Base Functions =====
            const kbUploadArea = document.getElementById('kbUploadArea');
            const kbFileInput = document.getElementById('kbFileInput');
            const kbDocBody = document.getElementById('kbDocBody');
            const kbSearchInput = document.getElementById('kbSearchInput');
            const kbSearchBtn = document.getElementById('kbSearchBtn');
            const kbSearchResults = document.getElementById('kbSearchResults');

            function formatSize(bytes) {
                if (bytes < 1024) return bytes + ' B';
                if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
            }

            function formatDate(iso) {
                if (!iso) return '-';
                const d = new Date(iso);
                return d.toLocaleDateString('zh-TW') + ' ' + d.toLocaleTimeString('zh-TW', {hour:'2-digit',minute:'2-digit'});
            }

            kbUploadArea.addEventListener('click', () => kbFileInput.click());
            kbUploadArea.addEventListener('dragover', e => { e.preventDefault(); kbUploadArea.classList.add('dragover'); });
            kbUploadArea.addEventListener('dragleave', () => kbUploadArea.classList.remove('dragover'));
            kbUploadArea.addEventListener('drop', e => {
                e.preventDefault();
                kbUploadArea.classList.remove('dragover');
                if (e.dataTransfer.files.length) uploadKbFiles(e.dataTransfer.files);
            });
            kbFileInput.addEventListener('change', () => { if (kbFileInput.files.length) uploadKbFiles(kbFileInput.files); });

            async function uploadKbFiles(files) {
                const fileArray = Array.from(files);
                const total = fileArray.length;
                let successCount = 0;
                let failCount = 0;
                let errors = [];

                for (let i = 0; i < fileArray.length; i++) {
                    const file = fileArray[i];
                    kbUploadArea.innerHTML = `<div class="upload-icon spin"><i class="fas fa-spinner"></i></div><div class="upload-text"><h3>ä¸Šå‚³ä¸­... (${i + 1}/${total})</h3><p>${file.name}</p></div>`;
                    
                    const fd = new FormData();
                    fd.append('file', file);
                    try {
                        const res = await fetch('/admin/rag/documents', {
                            method: 'POST',
                            headers: { 'Authorization': 'Bearer ' + getToken() },
                            body: fd,
                        });
                        const data = await res.json();
                        if (res.ok || res.status === 207) {
                            successCount++;
                        } else {
                            failCount++;
                            errors.push(`${file.name}: ${data.error || 'ä¸Šå‚³å¤±æ•—'}`);
                        }
                    } catch (e) {
                        failCount++;
                        errors.push(`${file.name}: ${e.message}`);
                    }
                }

                let message = `ä¸Šå‚³å®Œæˆï¼šæˆåŠŸ ${successCount} å€‹`;
                if (failCount > 0) {
                    message += `ï¼Œå¤±æ•— ${failCount} å€‹`;
                }
                if (errors.length > 0 && errors.length <= 3) {
                    message += '\n' + errors.join('\n');
                } else if (errors.length > 3) {
                    message += '\n' + errors.slice(0, 3).join('\n') + `\n...åŠå…¶ä»– ${errors.length - 3} å€‹éŒ¯èª¤`;
                }
                alert(message);

                kbUploadArea.innerHTML = '<div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div><div class="upload-text"><h3>é»æ“Šæˆ–æ‹–æ”¾æ–‡ä»¶ä¸Šå‚³</h3><p>æ”¯æ´æ ¼å¼ï¼šPDFã€TXTã€Markdownï¼ˆå¯æ‰¹é‡ä¸Šå‚³ï¼‰</p></div><input type="file" id="kbFileInput" accept=".pdf,.txt,.md" multiple style="display:none;">';
                document.getElementById('kbFileInput').addEventListener('change', () => { if (kbFileInput.files.length) uploadKbFiles(kbFileInput.files); });
                loadKbDocuments();
            }

            async function loadKbDocuments() {
                try {
                    const res = await fetch('/admin/rag/documents', { headers: { 'Authorization': 'Bearer ' + getToken() } });
                    const data = await res.json();
                    if (!res.ok) { kbDocBody.innerHTML = '<tr><td colspan="7" class="kb-empty">è¼‰å…¥å¤±æ•—</td></tr>'; return; }

                    const docs = data.documents || [];
                    if (docs.length === 0) {
                        kbDocBody.innerHTML = '<tr><td colspan="7" class="kb-empty">å°šç„¡æ–‡ä»¶ã€‚ä¸Šå‚³æ–‡ä»¶ä»¥å»ºç«‹çŸ¥è­˜åº«ã€‚</td></tr>';
                        return;
                    }
                    kbDocBody.innerHTML = docs.map(d => `
                        <tr>
                            <td><a href="/view_rag_document/${d.id}/${encodeURIComponent(d.original_filename)}" target="_blank" class="kb-doc-link" title="${d.original_filename}">${d.original_filename.length > 30 ? d.original_filename.slice(0,27)+'...' : d.original_filename}</a></td>
                            <td>${d.content_type.split('/').pop().toUpperCase()}</td>
                            <td>${formatSize(d.file_size)}</td>
                            <td>${d.chunk_count || 0}</td>
                            <td><span class="kb-status ${d.status}">${d.status}</span></td>
                            <td>${formatDate(d.created_at)}</td>
                            <td>
                                <button class="kb-btn kb-btn-reprocess" onclick="reprocessDoc(${d.id})"><i class="fas fa-redo"></i></button>
                                <button class="kb-btn kb-btn-delete" onclick="deleteDoc(${d.id})"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `).join('');
                } catch (e) {
                    kbDocBody.innerHTML = '<tr><td colspan="7" class="kb-empty">éŒ¯èª¤: ' + e.message + '</td></tr>';
                }
            }

            window.deleteDoc = async function(id) {
                if (!confirm('ç¢ºå®šåˆªé™¤æ­¤æ–‡ä»¶åŠæ‰€æœ‰ç›¸é—œè³‡æ–™ï¼Ÿ')) return;
                try {
                    await fetch(`/admin/rag/documents/${id}`, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + getToken() } });
                    loadKbDocuments();
                } catch (e) { alert('åˆªé™¤å¤±æ•—: ' + e.message); }
            };

            window.reprocessDoc = async function(id) {
                if (!confirm('é‡æ–°åˆ†æ®µä¸¦åµŒå…¥æ­¤æ–‡ä»¶ï¼Ÿ')) return;
                try {
                    const res = await fetch(`/admin/rag/documents/${id}/reprocess`, { method: 'POST', headers: { 'Authorization': 'Bearer ' + getToken() } });
                    const data = await res.json();
                    alert(data.message || 'å®Œæˆ');
                    loadKbDocuments();
                } catch (e) { alert('é‡æ–°è™•ç†å¤±æ•—: ' + e.message); }
            };

            kbSearchBtn.addEventListener('click', searchKb);
            kbSearchInput.addEventListener('keydown', e => { if (e.key === 'Enter') searchKb(); });

            async function searchKb() {
                const query = kbSearchInput.value.trim();
                if (!query) return;
                kbSearchResults.innerHTML = '<div class="kb-empty">æœå°‹ä¸­...</div>';
                try {
                    const res = await fetch('/admin/rag/search', {
                        method: 'POST',
                        headers: { 'Authorization': 'Bearer ' + getToken(), 'Content-Type': 'application/json' },
                        body: JSON.stringify({ query }),
                    });
                    const data = await res.json();
                    if (!res.ok) { kbSearchResults.innerHTML = '<div class="kb-empty">éŒ¯èª¤: ' + (data.error || 'æœå°‹å¤±æ•—') + '</div>'; return; }

                    const results = data.results || [];
                    if (results.length === 0) {
                        kbSearchResults.innerHTML = '<div class="kb-empty">æœªæ‰¾åˆ°ç›¸é—œçµæœ</div>';
                        return;
                    }
                    kbSearchResults.innerHTML = results.map((r, i) => `
                        <div class="kb-result-item">
                            <div class="kb-result-meta">
                                <i class="fas fa-file-alt"></i> #${i+1} | ${r.document_name}${r.page_number ? ' p.' + r.page_number : ''}${r.heading ? ' | ' + r.heading : ''} | ç›¸é—œåº¦: ${(r.similarity * 100).toFixed(0)}%
                            </div>
                            <div class="kb-result-content">${r.content.length > 500 ? r.content.slice(0,500)+'...' : r.content}</div>
                        </div>
                    `).join('');
                } catch (e) {
                    kbSearchResults.innerHTML = '<div class="kb-empty">éŒ¯èª¤: ' + e.message + '</div>';
                }
            }
        });
    </script>
</body>
</html>
